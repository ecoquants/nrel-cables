---
title: "Submarine Cable Analysis for Marine Renewable Energy Development"
csl: apa.csl
output:
  bookdown::pdf_document2:
    keep_tex: yes
    toc: yes
    toc_depth: 4
  bookdown::html_document2:
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
  bookdown::word_document2:
    toc: yes
tables: yes
bibliography: nrel-cables.bib
---

```{r setup, include=FALSE}
# set working directory
if (basename(getwd()) == 'nrel-cables') setwd('docs')

# load packages and variables
source('./packages_vars.R')

#opts_chunk$set(warning=F, message=F)
opts_chunk$set(warning=F, message=F, eval=F) # DEBUG

if (interactive() || "rmarkdown.pandoc.to" %in% names(opts_knit$get()) && opts_knit$get("rmarkdown.pandoc.to") == 'html'){
  out_html = T
  #opts_chunk$set(echo=T)
  opts_chunk$set(echo=F)
} else {
  out_html = F
  opts_chunk$set(echo=F)
}

fmt_tbl = function(csv, energy_hdr, caption){

  d = read_csv(csv) %>%
    filter(
      territory != 'ALL',
      !is.na(territory))
  
  hdr = htmltools::withTags(table(
    class = 'display',
    thead(
      tr(
        th(rowspan=2, 'Territory'),
        th(rowspan=2, energy_hdr),
        th(rowspan=2, 'Area (km2)'),
        th(colspan=2, 'Min. Cable (2x)'),
        th(colspan=2, 'Rec. Cable (3x)')),
      tr(
        th('Area (km2)'),
        th('(%)'),
        th('Area (km2)'),
        th('(%)')))))

  d %>%
    mutate(
      territory  = ifelse(duplicated(territory), '', territory),
      energy     = factor(energy_num, unique(energy_num), unique(energy_lbl)),
      area_km2   = accounting(area_km2, digits=0),
      cable2_km2 = accounting(cable2_km2, digits=0),
      cable3_km2 = accounting(cable3_km2, digits=0),
      cable2_pct = percent(cable2_pct, digits=1),
      cable3_pct = percent(cable3_pct, digits=1)) %>%
    select(
      territory, energy, area_km2,
      cable2_km2, cable2_pct, cable3_km2, cable3_pct) %>%
    formattable(
      list(
        energy     = color_bar('lightblue'),
        area_km2   = color_bar('lightgray'),
        cable2_km2 = color_bar('lightpink'),
        cable3_km2 = color_bar('lightgreen'))) %>%
    as.datatable(
      rownames=F, container=hdr, caption=caption,
      options = list(
        dom='t', # off: n_entries/search/paging/ordering
        pageLength = nrow(tbl), ordering=F,
        columnDefs = list(list(className='dt-right', targets=1:5))))
}

dx2     = read_sf(dx2_geo)
dx3     = read_sf(dx3_geo)
lns_d1x = read_sf(lns_d1x_rgn_geo)

plot_cbls = function(
  csv   = wave_cbls_csv, 
  title = 'Wave Energy by Area and Power Class per US Territory',
  xlab  = 'Wave energy (kW/m)',
  legend_position      = c(1,0),
  legend_justification = c(1,0)){ 
  
  energy_cbls = read_csv(csv) %>%
    filter(
      !is.na(territory),
      territory != 'ALL') %>%
    mutate(
      energy = factor(energy_lbl, unique(energy_lbl), ordered=T),
      pct_lbl = sprintf('%0.1f - %0.1f%%', cable2_pct*100, cable3_pct*100))
  
  cable_ord = c('min_2d'='Minimum (2*depth)', 'rec_3d'='+Recommended (3*depth)', 'rem'='Available')
  
  d_p = energy_cbls %>%
    mutate(
      min_2d = cable2_km2,
      rec_3d = cable3_km2 - cable2_km2,
      rem    = area_km2 - cable3_km2) %>%
    select(
      territory, energy, min_2d, rec_3d, rem) %>%
    gather(type, km2, -energy, -territory) %>%
    mutate(
      type = factor(
        type,
        names(cable_ord),
       cable_ord, ordered=T)) %>%
    arrange(territory, energy, type)
  
  txt_adj = energy_cbls %>% 
    summarize(txt_adj = max(area_km2)/1000*0.025) %>% 
    .$txt_adj
  
  p = ggplot(
      data=d_p,
      aes(x = energy, y = km2/1000, fill=type)) +
    geom_col() +
    geom_text(
      data=energy_cbls, 
      aes(label=pct_lbl, x=energy, y=area_km2/1000, fill=NULL), 
      position = position_nudge(y = txt_adj), size=2) +
    labs(
      title=title, 
      subtitle='with Cable Overlay (Minimum - Recommended %)', 
      x=xlab, y='Area (1,000 km^2)', fill='Type') +
    theme(
      legend.justification = legend_justification, 
      legend.position      = legend_position,
      axis.text.x = element_text(angle = 90, hjust = 1)) + 
    facet_wrap(~territory) # facet_wrap(~territory, scales='free_y') # facet_grid(. ~ territory)
  p
}

usa_eez = read_sf(usa_rgn_geo)
#wrld2   = st_as_sf(map('world2', plot=F, fill=T))
#usa2    = wrld2 %>% filter(ID=='USA')
land    = read_sf(land_usaeez_geo)
```

# Background

Demand for abundant and diverse resources in the oceans is growing, necessitating marine spatial planning. To inform development of Marine Hydrokinetic (MHK) and Offshore Wind (OSW) resources, DOE has asked NREL to identify — and mitigate where possible — the competing uses between MHK/OSW technologies and subsea power/telecoms cables. The first step in this work is to identify and quantify the overlap between the MHK/OSW resource availability and existing cable routes. Several publicly available data layers are available that identify cable routes (e.g. MarineCadastre.gov currently hosts an offshore cables geographical information system (GIS) data layer) and MHK/OSW resource density (MHK Atlas, Wind Prospector). The cable route linear features, however, do not indicate the setback distance necessary to accommodate subsea cable maintenance requirements. Preliminary work was done within NREL to evaluate the influence of subsea cable setback distance on the overlap with MHK/OSW for the west coast of the U.S [@amante_offshore_2016]. Industry reports [@communicationssecurityreliabilityandinteroperabilitycounciliv_clustering_2016; @communicationssecurityreliabilityandinteroperabilitycounciliv_protection_2014] from the International Cable Protection Committee (ICPC) of the North American Submarine Cable Association (NASCA; [n-a-s-c-a.org](https://www.n-a-s-c-a.org/)) advise on setback distances that inform this analysis.

# Methods

## Study Area and Submarine Cables

The study area included the 200 nm extent of US waters downloaded from MarineRegions.org ^[MarineRegions.org US exclusive economic zone (EEZ) data, version World_EEZ_v9_20161021] and overlapping the offshore cable data layer available through MarineCadastre.gov ^[MarineCadastre.gov cable metadata: https://coast.noaa.gov/dataservices/Metadata/TransformMetadata?u=https://coast.noaa.gov/data/Documents/Metadata/harvest/MarineCadastre/NOAAChartedSubmarineCables.xml&f=html]. See Figure \@ref(fig:mapStudyArea).

TODO: add citations to bibliography:

- [MarineRegions.org](http://marineregions.org/downloads.php) > Exclusive Economic Zones Boundaries (EEZ), version: World EEZ v9 (2016-10-21, 123 MB). Suggested citation:

    - Flanders Marine Institute (2016). Maritime Boundaries Geodatabase, version 1. Available online at http://www.marineregions.org/. Consulted on 2017-04-25.

- [MarineCadastre.gov cable metadata](https://coast.noaa.gov/dataservices/Metadata/TransformMetadata?u=https://coast.noaa.gov/data/Documents/Metadata/harvest/MarineCadastre/NOAAChartedSubmarineCables.xml&f=html)

See Table \@ref(tab:tblDataSources).

```{r tblDataSources}
read_csv('../data/data_sources.csv') %>%
  kable(
    caption = 'Data sources from preliminary report.') # , booktabs=T)
```

## tbl_eez-usa

```{r tblUSATerrritories}
usa = read_sf(usa_rgn_s_geo)

tbl = usa %>%
  as_tibble() %>%
  select(territory, area_km2) %>%
    mutate(
      area_km2   = accounting(area_km2, digits=0)) %>%
    select(
      Territory=territory, `Area (km2)`=area_km2)

tbl %>%
  formattable(list(
    `Area (km2)` = color_bar('lightgray'))) %>%
  as.datatable(
    rownames = F, 
    caption  = 'Territories within the United States exclusive economic zone (EEZ).',
    options  = list(
      dom='t', # off: n_entries/search/paging/ordering
      pageLength = nrow(tbl), ordering=F,
      columnDefs = list(list(className='dt-right', targets=1))))
```

```{r mapStudyArea, fig.cap='Map of NOAA Charted Submarine cables in the United States as of December 2012.'}
lns_rgn = read_sf(lns_rgn_geo)

pal <- colorFactor(
  colorRampPalette(brewer.pal(11,'Spectral'))(length(usa$territory)),
  usa$territory)

m = leaflet(usa) %>%
  addProviderTiles('Esri.OceanBasemap') %>%
  addPolylines(
    data = lns_rgn, group='cables',
    color='black', opacity = 1, weight=1,
    popup = ~sprintf(
      "scaleBand: %s<br>description: %s<br>effectiveDate: %s",
      scaleBand, description, effectiveDate)) %>%
  addPolygons(
   label = ~sprintf('%s', territory),
   color = ~pal(territory)) #%>%
if (out_html){
  m
} else {
  # [How to save Leaflet in R map as png or jpg file? - Stack Overflow](https://stackoverflow.com/questions/31336898/how-to-save-leaflet-in-r-map-as-png-or-jpg-file)
  m_html = '../tmp/mapStudyArea.html'
  m_png  = '../tmp/mapStudyArea.png'
  saveWidget(m, m_html, selfcontained=F)
  webshot(m_html, file=m_png, cliprect="viewport")
}
```

## Depth

The bathymetric depth comes from the [GEBCO 30 arc-second grid](http://www.gebco.net/data_and_products/gridded_bathymetry_data/gebco_30_second_grid/). Here's there requested attribution:

**GEBCO_2014 Grid, version 20150318, www.gebco.net**

## Renewable Energy

NREL.

## Avoidance Zones for Siting New Facilities

"ICPC Recommendation 13 No. 2, which establishes a methodology for determining site-specific proximity limits between submarine cables and offshore wind facilities and a default separation distance in shallower waters of 500 meters on either side of an in-service submarine cable — a separation standard the principles of which also apply to other offshore renewable energy projects."

"Subsea Cables UK Guideline No. 6 (endorsed by NASCA), which establishes principles for determining safe proximity distances and negotiating proximity agreements between offshore wind farms and submarine cables and reflects extensive experience in the United Kingdom with managing spatial conflicts between offshore wind farms and submarine cables."

"endorse a default separation distance of 500 meters in water depths of less than 75 meters and the greater of 500 meters or two times the depth of water in greater water depths."

1. **Default separation distance** by depth:
    - `<= 250 m`: 500 m
    - `> 250 m`: 2 x depth

Psudocode:

```
# buffer based on depth
cables_buffers = list()
for (x in unique(cable_cells$depth)){

  cables_buffers[str(x)] = cable_cells %>%
    subset(depth == x) %>%
    buffer(x)

}
cable_buf = merge(cables_buffers)

# smooth out jagged edges between cells
cable_buf = simplify(cable_buf)
```

## Separation Zones for Routing New Cables

"ICPC Recommendation 2 No. 10: parallel submarine cables maintain a separation distance of the lesser of 3 times depth of water or (where not achievable) 2 times the depth of water following consultation and agreement between affected parties — a separation standard the principles of which also apply to spacing of submarine cables and other marine infrastructure"

At least 2 separation zones based on depth:

1. **Minimum**:  2 times the depth of water

1. **Recommended**: 3 times depth of water

Psudocode:

```
# convert depth (GEBCO 30 sec resolution) to polygons of cells
depth_cells = as.polygon(depth_raster)

# intersect cables with depth cells
cable_cells = intersect(cables_lines, depth_cells)

# buffer based on depth
cables_buffers = list()
for (x in unique(cable_cells$depth)){

  cables_buffers[str(x)] = cable_cells %>%
    subset(depth == x) %>%
    buffer(x)

}
cable_buf = merge(cables_buffers)

# smooth out jagged edges between cells
cable_buf = simplify(cable_buf)
```

## Depth-Varying Buffer

A depth-varying buffer to the offshore cables, 2 \* depth for "minimum" and 3 \* depth for "recommended" separation zones for routing new cables, by first intersecting depth with cables, then iterating over each depth to apply the appropriate buffers before finally dissolving all buffers. In order to apply the buffer, I needed to project from geographic coordinates to a projection that minimizes area distortion, so chose Albers Equal Area and applied the ["one-sixth rule"]( http://desktop.arcgis.com/en/arcmap/latest/map/projections/albers-equal-area-conic.htm#GUID-2158C4F9-F197-458E-94F0-84933C1BE6B7) based on the extent of the cable features to minimize distortion.

# Results

## Cable Buffer

```{r mapCableBuffs, eval=T}

#out_html=F
map_cbls = function(){
  
  if (out_html){
    m = leaflet() %>%
    addProviderTiles("Stamen.TonerLite", group = "B&W") %>%
    addProviderTiles('Esri.OceanBasemap', group = "Ocean") %>%  #
    addPolygons(
      data = dx2, group='Min. Cable (2x)',
      color='red', stroke=F, fillOpacity = 0.5) %>%
    addPolygons(
      data = dx3, group='Rec. Cable (3x)',
      color='red', stroke=F, fillOpacity = 0.5) %>%
    addPolylines(
      data = lns_d1x, group='Cables',
      color='black', opacity = 1, weight=1,
      popup = ~sprintf(
        "scaleBand: %s<br>description: %s<br>effectiveDate: %s<br>Territory: %s<br>Buffer (1x): %d",
        scaleBand, description, effectiveDate, territory, buf1x)) %>%
    addLayersControl(
      baseGroups = c("B&W", "Ocean"),
      overlayGroups = c('Min. Cable (2x)', 'Rec. Cable (3x)', 'Cables'),
      options = layersControlOptions(collapsed = FALSE))
    
    m
  } else {
    
    bb = st_bbox(dx3)    
    p = ggplot() +
      geom_sf(data=wrld2, fill='lightgray') +
      geom_sf(data=dx3, fill='red', color='red') +
      coord_sf(
        xlim=bb[c('xmin','xmax')], 
        ylim=bb[c('ymin','ymax')])
    p
  }
}
map_cbls()
```

Generated by:

- [create_cable-buffer.R](https://github.com/ecoquants/nrel-cables/blob/master/docs/create_cable-buffer.R)

- [extract_cable-energy.R](https://github.com/ecoquants/nrel-cables/blob/master/docs/extract_cable-energy)

Google Earth files (*.kml):

- [buf_2xdepth-incr100m.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/buf_2xdepth-incr100m.kml)

- [buf_3xdepth-incr100m.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/buf_3xdepth-incr100m.kml)

- [lns_d1x.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/lns_d1x.kml)

## Overlap of Cable Buffer with Renewable Energy

Extract average and area of overlap between zones and renewable energy potential areas, possibly at various depth bins.

```{r pltEnergy}
read_cbls = function(csv, form){
  read_csv(csv) %>%
    filter(
      territory == 'ALL') %>%
    mutate(
      form    = form,
      #energy  = factor(energy_lbl, unique(energy_lbl), ordered=T),
      pct_lbl = sprintf('%0.1f - %0.1f%%', cable2_pct*100, cable3_pct*100))
}

tbl_form_cbls = map2(
  c(wind_cbls_csv, wave_cbls_csv, tide_cbls_csv), 
  c('wind','wave','tide'), 
  read_cbls) %>%
  bind_rows() %>%
  mutate(
    energy = factor(
      x      = sprintf('%s_%04d', form, energy_num), 
      levels = sprintf('%s_%04d', form, energy_num), 
      label  = energy_lbl, ordered=T))

cable_ord = c('min_2d'='Minimum (2*depth)', 'rec_3d'='+Recommended (3*depth)', 'rem'='Available')
  
d_p = tbl_form_cbls %>%
  mutate(
    min_2d = cable2_km2,
    rec_3d = cable3_km2 - cable2_km2,
    rem    = area_km2 - cable3_km2) %>%
  select(
    form, energy, min_2d, rec_3d, rem) %>%
  gather(type, km2, -energy, -form) %>%
  mutate(
    type = factor(
      type,
      names(cable_ord),
      cable_ord, ordered=T)) %>%
  arrange(form, energy, type)

txt_adj = energy_cbls %>% 
  summarize(txt_adj = max(area_km2)/1000*0.025) %>% 
  .$txt_adj

p = ggplot(
  data=d_p,
  aes(x = energy, y = km2/1000, fill=type)) +
  geom_col() +
  geom_text(
    data=tbl_form_cbls, 
    aes(label=pct_lbl, x=energy, y=area_km2/1000, fill=NULL), 
    position = position_nudge(y = txt_adj), size=2) +
  labs(
    title    = 'Energy by Area and Power Class per US Territory', 
    subtitle = 'with Cable Overlay (Minimum - Recommended %)', 
    x='Energy', y='Area (1,000 km^2)', fill='Type') +
  theme(
    legend.justification = c(1,1), 
    legend.position      = c(1,1),
    axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_wrap(~form, scales='free_x')
p
```

```{r tblEnergy}
d = tbl_form_cbls
energy_hdr = 'Amount'
caption = 'Area overlap with cables by form of energy broken into size classes across all territories.'

# update energy column for proportion in color_box
e_lbls = c(
    '<=7','7-8',  '8-9','9-10','10-11','11-12', #  1:6
   '0-10',   '10-20',    '20-30',  '>30',       #  7:10
  '0-500','500-1000','1000-1500','>1500')       # 11:14
e_idx = c(1,7,11, 2,8,12, 3, 4,9,13, 5,10,14, 6)
e_lkup = setNames(e_idx, 1:14)
d = d %>% 
  mutate(
    form = ifelse(
      duplicated(form), '',       c(
        'tide'='Tidal Power (W/m2)',
        'wave'='Wave Energy (kW/m)',
        'wind'='Wind Speed (m/s)')[d$form]),
    energy = factor(
      x = e_lkup %>% sort() %>% names %>% as.integer,
      levels = 1:14,
      labels = e_lbls[e_idx],
      ordered=T),
    area_km2   = accounting(area_km2, digits=0),
    cable2_km2 = accounting(cable2_km2, digits=0),
    cable3_km2 = accounting(cable3_km2, digits=0),
    cable2_pct = percent(cable2_pct, digits=1),
    cable3_pct = percent(cable3_pct, digits=1)) %>%
  select(
    form, energy, area_km2,
    cable2_km2, cable2_pct, cable3_km2, cable3_pct)

hdr = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan=2, 'Energy'),
      th(rowspan=2, 'Area (km2)'),
      th(colspan=2, 'Min. Cable (2x)'),
      th(colspan=2, 'Rec. Cable (3x)')),
    tr(
      th('Form'),
      th('Amount'),
      th('Area (km2)'),
      th('(%)'),
      th('Area (km2)'),
      th('(%)')))))

d %>%
  formattable(
    list(
      energy     = color_bar('lightblue'),
      area_km2   = color_bar('lightgray'),
      cable2_km2 = color_bar('lightpink'),
      cable3_km2 = color_bar('lightgreen'))) %>%
  as.datatable(
    rownames=F, container=hdr, 
    caption = caption,
    options = list(
      dom='t', # off: n_entries/search/paging/ordering
      pageLength = nrow(tbl), ordering=F,
      columnDefs = list(list(className='dt-right', targets=1:5))))
```

### Wind

units: wind speed (m/s) at 90m hub height

TODO:
- [Visualise sf objects — ggsf • ggplot2](http://ggplot2.tidyverse.org/reference/ggsf.html)

```{r land selectFeatures}
# resolve land / eez mismatch of borders by filling in eez not high seas
    
# paste(usa_eez$territory, collapse=', ')
#  Alaska, East, Guam, Gulf of Mexico, Hawaii, 
#  Johnston Atoll, N Mariana Islands, Palmyra Atoll, Puerto Rico, 
#  US Virgin Islands, Wake Island, West

ter = 'West' 
land_ter_geo = sprintf('../data/land_%s.geojson', str_replace_all(ter,' ','-'))
#eez_buf_n01 = st_buffer(eez %>% filter(territory==ter), dist = -0.1)
# plot(eez['territory'])
# plot(eez_buf_n01['territory'])

eez_ter = usa_eez %>% filter(territory==ter) # plot(eez_ter['territory'])
bb = st_bbox(eez_ter)
# TODO: st_cast(x=st_bbox, to=st_polygon)
bb_ply = st_sf(
  tibble(
    territory = ter,
    geom = st_sfc(st_polygon(list(rbind(
      c(bb['xmin'], bb['ymin']),
      c(bb['xmax'], bb['ymin']),
      c(bb['xmax'], bb['ymax']),
      c(bb['xmin'], bb['ymax']),
      c(bb['xmin'], bb['ymin'])))), crs = 4326)))

bb_dif = st_difference(bb_ply, eez_ter) %>%
  st_cast('POLYGON', do_split=T)

i_rm = selectFeatures(bb_dif, index=T)
land1 = bb_dif[setdiff(1:nrow(bb_dif), i_rm),] %>%
  group_by(territory) %>%
  summarize()

write_sf(land1, land_ter_geo, delete_dsn=T)
plot(land1)

```

```{r land rm_wrld2}
land1 = read_sf(land_ter_geo)

geos = sprintf(
  '../data/land_%s.geojson', 
  str_replace_all(
    c('Alaska', 'West', 'East', 'Gulf of Mexico'),' ','-'))

ter_sf = function(ter){
  geo = sprintf('../data/land_%s.geojson', str_replace_all(ter, ' ','-'))
  read_sf(geo)
}

ter_geo2shp = function(ter){
  geo = sprintf('../data/land_%s.geojson', str_replace_all(ter, ' ','-'))
  shp = sprintf('../data/land_%s.shp', str_replace_all(ter, ' ','_'))
  read_sf(geo) %>%
    write_sf(shp, delete_dsn=T)
}
ter_geo2shp('Alaska')
ter_geo2shp('West')
ter_geo2shp('East')
ter_geo2shp('Gulf of Mexico')

ter_geo2shp('Johnston Atoll')
ter_geo2shp('N Mariana Islands')
ter_geo2shp('Palmyra Atoll')
ter_geo2shp('Puerto Rico')
ter_geo2shp('US Virgin Islands')
ter_geo2shp('Wake Island')

ter_geo2shp('Guam')
ter_geo2shp('Hawaii')
#  Guam, Hawaii



ter='Alaska'
ter_sf(ter) %>%
  write_sf(
    sprintf('../data/land_%s.shp', str_replace_all(ter,' ','-')), 
    delete_dsn=T)

alaska = ter_sf('Alaska') # plot(alaska)
west = ter_sf('Alaska')
east = ter_sf('East')
gomex = ter_sf('Gulf of Mexico')

nam = rbind(alaska, west, east, gomex)
plot(nam)

wrld2 %>% 
  filter(ID=='USA') %>%
  write_sf('../data/usa2.shp')

wrld2 %>% 
  filter(ID!='USA') %>%
  write_sf('../data/wrld2_notusa2.shp')

nam = st_union(st_combine(nam))
usa2 = st_difference(
  , 
  )
write_sf(usa2, '../data/land_usa2.geojson', delete_dsn=T)

write_sf(wrld2, '../data/land_world2.geojson', delete_dsn=T)

wrld3 = st_difference(wrld2, land1)
mapview(wrld3)
                      
wrld2_i = wrld2 %>% 
  filter(
    ID!='USA',
    st_intersects(wrld2, bb_ply, sparse=F)[,1])



land2 = st_difference(land1, st_union(st_combine(wrld2_i)))

write_sf(land1, land_ter_geo, delete_dsn=T)
plot(land2)
#land1_e = editFeatures(land1)


land4 = read_sf('../data/land_wrld2_usaeez_platecarree.shp') %>% as('Spatial') %>%
  spTransform("+proj=longlat +datum=WGS84 +lon_wrap=180")
plot(land4['ID'])

land5 = readOGR('../data','land_wrld2_usaeez') %>%
  spTransform("+proj=longlat +datum=WGS84 +lon_wrap=180")
plot(land5)

land6 = readOGR('../data','land_wrld2_usaeez_platecarree') %>%
  spTransform("+proj=longlat +datum=WGS84 +lon_wrap=180")
plot(land6)

#ogr2ogr -s_srs EPSG:4326 -t_srs "+proj=longlat +ellps=WGS84 +pm=-180 +datum=WGS84 +no_defs" land_wrld2_usaeez_shifted.shp land_wrld2_usaeez.shp

# [ogr - How to change shapefile longitude from -180 - 180 to 0 - 360? - Geographic Information Systems Stack Exchange](https://gis.stackexchange.com/questions/79447/how-to-change-shapefile-longitude-from-180-180-to-0-360#answer-79448)
ogr2ogr -t_srs "+proj=latlong +pm=-360" tmp.shp land_wrld2_usaeez.shp

tmp = readOGR('../data','tmp') %>%
  spTransform("+proj=longlat +datum=WGS84 +lon_wrap=180")
plot(tmp)

ogr2ogr -skipfailures world_part1.shp land_wrld2_usaeez.shp -clipsrc -180 -90 0 90
ogr2ogr -skipfailures world_part2.shp land_wrld2_usaeez.shp -clipsrc 0 -90 180 90
ogr2ogr world_part1_shifted.shp world_part1.shp -dialect sqlite -sql "SELECT ShiftCoords(geometry,360,0), ID, territory FROM world_part1"
ogr2ogr world_0_360_raw.shp world_part2.shp
ogr2ogr -update -append world_0_360_raw.shp world_part1_shifted.shp -nln world_0_360_raw
ogr2ogr world_0_360.shp world_0_360_raw.shp -dialect sqlite -sql "SELECT ST_Union(Geometry), ID, territory FROM world_0_360_raw GROUP BY ID, territory"

land_w = readOGR('../data','world_0_360') 
land_w = read_sf('../data/world_0_360.shp') 
land_w %>% write_sf(land_usaeez_geo, delete_dsn=T)

plot(land_w['ID'])


land7 = readOGR('../data','land_wrld2_usaeez_shifted') %>%
  spTransform("+proj=longlat +datum=WGS84 +lon_wrap=180") %>%
land7 = land7 %>% st_as_sf()
plot(land7['ID'])

ogr2ogr world_part1.shp world.shp -clipsrc -180 -90 0 90
ogr2ogr world_part2.shp world.shp -clipsrc 0 -90 180 90

%>% st_as_sf() %>%
  write_sf('../data/land_wrld2_usaeez_platecarree.shp')


land2 = land %>% as('Spatial') %>%
  spTransform("+proj=longlat +datum=WGS84 +lon_wrap=180")
land2 = land2 %>% st_as_sf()
plot(land2 %>% filter(ID=='Algeria'))

land3 = cleangeo::clgeo_Clean(land2 %>% as('Spatial'))
plot(land3['ID'])
filter(land3, ID=='Algeria') %>% select(ID) %>% plot()

land2 = land2  
  mutate(
    #geometry   = (geometry + c(360,90)) %% c(360) - c(0,90),
    geom_valid = st_is_valid(geometry)) # Algeria, Mali


land2 %>% filter(!geom_valid)
plot(land2 %>% filter(ID=='Algeria') %>% st_buffer(dist=0))
plot( %>% st_buffer(dist=0))

st_is_valid(land2)
write_sf(land2, '../data/land_wrld2_usaeez.geojson', delete_dsn=T)
    st_set_crs(crs_gcs_w)

read_sf()

wave_sf = wave_sf %>%
    mutate(geometry = (geometry + c(360,90)) %% c(360) - c(0,90)) %>% 
    st_set_crs(crs_gcs_w)
```


```{r map_energy_sf, eval=T}

map_energy_sf = function(
  energy_sf,
  ter,
  legend_title,
  redo,
  fig){
  # ter = 'Hawaii'; fig = sprintf('figs/mapWind_%s.pdf', str_replace_all(ter,' ','-')); energy_sf = wind_sf; legend_title = 'Wind\nspeed\n(m/s)'; redo = T
  
  
  if (!file.exists(fig) | redo){
    
    d = energy_sf %>% 
      filter(territory==ter)
    eez = usa_eez %>%
      filter(territory==ter)
    cables = lns_d1x %>%
      filter(territory==ter)
    cables2 = dx2 %>%
      filter(territory==ter)
    cables3 = dx3 %>%
      filter(territory==ter)
    
    bb = st_bbox(d)
    # TODO: st_cast(x=st_bbox, to=st_polygon)                 
    bb_ply = st_sf(
      tibble(
        territory = ter,
        geom = st_sfc(st_polygon(list(rbind(
          c(bb['xmin'], bb['ymin']),
          c(bb['xmax'], bb['ymin']),
          c(bb['xmax'], bb['ymax']),
          c(bb['xmin'], bb['ymax']),
          c(bb['xmin'], bb['ymin'])))), crs = 4326)))
    earth = land %>%
      filter(
        st_intersects(land, bb_ply, sparse=F)[,1])
    plot(earth)

    p = ggplot(data=d) +
      geom_sf(aes(fill=energy), color=NA) +
      scale_fill_brewer(legend_title, palette='YlGnBu', direction=-1) +
      geom_sf(data=earth, fill='gray40', size=0.2, color=NA) +
      geom_sf(data=eez, fill=NA, color='gray40') +
      geom_sf(data=cables3, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables2, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables, color='red', size=0.1, alpha=0.9) +
      coord_sf(
        xlim=bb[c('xmin','xmax')], 
        ylim=bb[c('ymin','ymax')]) +
      theme(
        legend.background = element_rect(fill='grey90'))
      
    pdf(fig, width=6.5, height=5)
    #print(p0)
    print(p)
    dev.off()
  }
  system(sprintf('open %s', fig))
  knitr::include_graphics(fig)
}

ter = 'Hawaii'
fig = sprintf('figs/mapWave_%s.pdf', str_replace_all(ter,' ','-'))
map_energy_sf(
  energy_sf = wave_sf,
  ter = ter,
  legend_title = 'Wave\nEnergy\n(kW/m)',
  redo = T,
  fig = fig)
system(sprintf('open %s', fig))
```

```{r mapWind for ter in wind}
for (ter in unique(wind_sf$territory)){
    # ter = 'Hawaii'
  fig = sprintf('figs/mapWind_%s.pdf', str_replace_all(ter,' ','-'))
  map_energy_sf(
    energy_sf = wind_sf,
    ter = ter,
    legend_title = 'Wind\nspeed\n(m/s)',
    redo = T,
    fig = fig)
  system(sprintf('open %s', fig))
}
```


```{r mapWind Hawaii, eval=T, fig.cap='Wind Energy for Hawaii.'}
# wrld2 = st_as_sf(map('world2', plot=F, fill=T))
# usa2 = wrld2 %>% filter(ID=='USA')
# usa_eez = read_sf(usa_rgn_geo)
wind_sf = read_sf(wind_geo) %>%
  mutate(
    energy = factor(
      energy_num, unique(energy_num), unique(energy_lbl), ordered=T))

# tibble(
#   ter = unique(wind_sf$territory),
#   caption = sprintf()

ter = 'Hawaii'
fig = sprintf('figs/mapWind_%s.pdf', str_replace_all(ter,' ','-'))
map_energy_sf(
  energy_sf = wind_sf,
  ter = ter,
  legend_title = 'Wind\nspeed\n(m/s)',
  redo = T,
  fig = fig)
system(sprintf('open %s', fig))
```

```{r tblWind}
fmt_tbl(
  csv=wind_cbls_csv, energy_hdr='Wind Speed (m/s)',
  caption='Constraints of cable (minimum - recommended) categories of wind speed (m/s) at 90m hub height.')
```

```{r pltWind}
plot_cbls(
  csv   = wind_cbls_csv, 
  title = 'Wind Energy by Area and Power Class per US Territory',
  xlab  = 'Wind speed (m/s)',
  legend_position      = c(0,0.47),
  legend_justification = c(0,1))
```

### Wave

units: wave energy flux (kW/m)

```{r mapWaveHawaii, eval=T, fig.cap='Wave Energy for Hawaii.'}
# wrld2 = st_as_sf(map('world2', plot=F, fill=T))
# usa2 = wrld2 %>% filter(ID=='USA')
# usa_eez = read_sf(usa_rgn_geo)
wave_sf = read_sf(wave_geo) %>%
  mutate(
    energy = factor(
      energy_num, unique(energy_num), unique(energy_lbl), ordered=T))

# tibble(
#   ter = unique(wind_sf$territory),
#   caption = sprintf()

ter = 'Hawaii'
fig = sprintf('figs/mapWave_%s.pdf', str_replace_all(ter,' ','-'))
map_energy_sf(
  energy_sf = wave_sf,
  ter = ter,
  legend_title = 'Wave\nenergy\n(kW/m)',
  redo = T,
  fig = fig)
system(sprintf('open %s', fig))
```


```{r mapWave for ter in wave}
for (ter in unique(wind_sf$territory)){
    # ter = 'Hawaii'
  fig = sprintf('figs/mapWave_%s.pdf', str_replace_all(ter,' ','-'))
  map_energy_sf(
    energy_sf = wind_sf,
    ter = ter,
    legend_title = 'Wave\nenergy\n(kW/m)',
    redo = T,
    fig = fig)
  system(sprintf('open %s', fig))
}
```

```{r mapWave leaflet, eval=F}
# wave read, clean, dissolve internal polys, 
wave = read_sf(wave_geo) %>% 
  as('Spatial') %>% 
  clgeo_Clean() %>%
  st_as_sf() %>%
  filter(
    !is.na(territory)) %>%
  mutate(
    energy = factor(energy_num, labels=unique(energy_lbl), ordered=T)) %>%
  group_by(territory, energy) %>%
  summarise() # mapview(wave, zcol='energy')

pal = colorFactor('Spectral', wave$energy, reverse=T)

leaflet(wave %>% filter(territory=='East')) %>% 
  addProviderTiles('Esri.OceanBasemap') %>%
  addPolygons(
    color="#444444", weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.5,
    fillColor = ~pal(energy),
    label = ~sprintf(
      "<strong>%s</strong>: %s kW/m<sup>2</sup>",
      territory, energy) %>% lapply(HTML),
    highlightOptions = highlightOptions(
      color = "white", weight = 2, bringToFront = T)) %>%
  addLegend(pal=pal, values=~energy, title='Wave Energy (kW/m)')
# TODO: fix overlap w/ GoMex vs East and Puerto Rico vs US Virgin Islands
```


```{r tblWave}
fmt_tbl(
  csv=tide_cbls_csv, energy_hdr='Wave Energy (kW/m)',
  caption='Constraints of cable (minimum - recommended) categories of wave energy (m/s) at 90m hub height.')
```

- [plotly - stacked bar chart](https://plot.ly/r/bar-charts/#stacked-bar-chart)
- [plotly - horizontal bar chart](https://plot.ly/r/horizontal-bar-charts/#colored-horizontal-bar-chart)
- [plotly - percentages bar chart](https://plot.ly/ggplot2/geom_bar/#precentages)

```{r pltWave}
p = plot_cbls(
  csv   = wave_cbls_csv, 
  title = 'Wave Energy by Area and Power Class per US Territory',
  xlab  = 'Wave energy (kW/m)')

#plot_list = lapply(unique(d_p$territory), plot_wave)
if (out_html){
  #htmltools::tagList(lapply(plot_list, ggplotly))
  # individual: plot_wave('ALL') %>% ggplotly()
  
  #p %>% ggplotly()
  p %>% print()
} else {
  #invisible(lapply(plot_list, print))
  p %>% print()
}
```

### Tidal

units: mean power (W/m^2)

TODO: seperate tif into east and west for display in leaflet

```{r mapTide leaflet, eval=F}
#tide = raster(tide_tif)
#plot(tide_tif)
# TODO: in report.Rmd, leaflet viz tide rasters per territory w/ regex in data/tide_ter-*.tif

tide_ter_tif = '/Users/bbest/github/nrel-cables/data/tide_ter-East.tif'
r = raster(tide_ter_tif)
plot(r)
r_l = projectRasterForLeaflet(r)
plot(r_l)

#pal <- colorNumeric('Spectral', values(r_l), na.color='transparent', reverse=T)
#brks = c(0,500,1000,1500,10753)
pal = colorBin(
  'Spectral', values(r_l), bins =c(0,500,1000,1500,11000), 
  pretty=T, na.color='transparent', reverse=T)

leaflet() %>% 
  addProviderTiles('Esri.OceanBasemap') %>%
  addRasterImage(r_l, colors=pal, opacity=0.8, project=F) %>%
  addLegend(pal=pal, values=values(r_l), title='Tidal Energy (W/m^2)')
```


```{r map_tide, eval=T}

territories = read_csv(tide_cbls_csv) %>% 
  filter(territory !='ALL') %>% 
  .$territory %>% unique()

map_tide = function(
  ter,
  legend_title,
  redo,
  fig){
  # ter = 'Alaska'; fig = sprintf('figs/mapTide_%s.pdf', str_replace_all(ter,' ','-')); legend_title = 'Tidal\npower\n(W/m2)'; redo = T
  
  if (!file.exists(fig) | redo){
    
    ter_str = str_replace_all(ter, ' ', '-')
    tif = sprintf('../data/tide_ter-%s.tif', ter_str)
    r = raster(tif)

    #d = energy_sf %>% 
    #  filter(territory==ter)
    eez = usa_eez %>%
      filter(territory==ter)
    cables = lns_d1x %>%
      filter(territory==ter)
    cables2 = dx2 %>%
      filter(territory==ter)
    cables3 = dx3 %>%
      filter(territory==ter)
    
    bb = bbox(r)
    bb = c(xmin=bb[1,1], xmax=bb[1,2], ymin=bb[2,1], ymax=bb[2,2])
    # TODO: st_cast(x=st_bbox, to=st_polygon)                 
    bb_ply = st_sf(
      tibble(
        territory = ter,
        geom = st_sfc(st_polygon(list(rbind(
          c(bb['xmin'], bb['ymin']),
          c(bb['xmax'], bb['ymin']),
          c(bb['xmax'], bb['ymax']),
          c(bb['xmin'], bb['ymax']),
          c(bb['xmin'], bb['ymin'])))), crs = 4326)))
    earth = land %>%
      filter(
        st_intersects(land, bb_ply, sparse=F)[,1])

    # https://nrelscience.org/2013/05/30/this-is-how-i-did-it-mapping-in-r-with-ggplot2/
    d = as.data.frame(r, xy=T) %>% as_tibble()
    colnames(d) <- c('lon','lat','value')
    d = d %>% filter(!is.na(value))
    
    p = ggplot() + 
      geom_raster(data=d, aes(x=lon, y=lat, fill=value)) + 
      scale_fill_gradientn(
        legend_title,
        colours=rev(brewer.pal(11,'YlGnBu')),
        limits=c(0,cellStats(r, 'max')),
        na.value = 'transparent') +
      geom_sf(data=earth, fill='gray40', size=0.2, color=NA) +
      geom_sf(data=eez, fill=NA, color='gray40') +
      geom_sf(data=cables3, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables2, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables, color='red', size=0.1, alpha=0.9) +
      coord_sf(
        xlim=bb[c('xmin','xmax')], 
        ylim=bb[c('ymin','ymax')]) +
      theme(
        legend.background = element_rect(fill='grey90'),
        axis.title.x=element_blank(),
        axis.title.y=element_blank())
      
    pdf(fig, width=6.5, height=5)
    print(p)
    dev.off()
    
  }
  #system(sprintf('open %s', fig))
  knitr::include_graphics(fig)
}

# ter = 'Hawaii'
# fig = sprintf('figs/mapWave_%s.pdf', str_replace_all(ter,' ','-'))
# map_energy_sf(
#   energy_sf = wave_sf,
#   ter = ter,
#   legend_title = 'Wave\nEnergy\n(kW/m)',
#   redo = T,
#   fig = fig)
# system(sprintf('open %s', fig))
```


```{r mapTide for ter in tide}
territories = read_csv(tide_cbls_csv) %>% 
  filter(territory !='ALL') %>% 
  .$territory %>% unique()

for (ter in territories){
    # ter = 'Hawaii'
  fig = sprintf('figs/mapTide_%s.pdf', str_replace_all(ter,' ','-'))
  map_tide(
    ter = ter,
    legend_title = 'Tidal\npower\n(W/m2)',
    fig = fig,
    redo = T)
  system(sprintf('open %s', fig))
}
```

```{r tblTide}
fmt_tbl(
  csv        = tide_cbls_csv, 
  energy_hdr = 'Tidal power (W/m2)',
  caption    = 'Constraints of cable (minimum - recommended) categories of tidal 
  energy (W/m2) at 90m hub height.')
```

```{r pltTide}
plot_cbls(
  csv   = tide_cbls_csv, 
  title = 'Tidal Energy by Area and Power Class per US Territory',
  xlab  = 'Tidal power (W/m2)',
  legend_position      = c(1,1),
  legend_justification = c(1,1))
```


## Next Steps

- stacked histogram by cbl2/(cbl3-cbl2)/other; hist(wind$Speed_90)

- simplify as native geojson

Musial et al (2016):

- wind speed (m/s) -- Table A-3 (p. 48): <7, 7-8, 8-9, 9-10, 10-11, total

- depth classes (m) -- Table B-1 (p. 49): <30, 30-60, 60-700, 700-1000, >1000, total

- distance to shore (nm) -- Table B-2 (p. 50): <3, 3-12, 12-50, 50-200, total

- by states



# Conclusions

## Communication with Stakeholders

Products will be online and readily digestable by stakeholders.

# References
