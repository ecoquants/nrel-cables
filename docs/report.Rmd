---
title: "Submarine Cable Analysis for Marine Renewable Energy Development"
csl: apa.csl
output:
  bookdown::pdf_document2:
    keep_tex: yes
    toc: yes
    toc_depth: 4
  bookdown::html_document2:
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
  bookdown::word_document2:
    toc: yes
    toc_depth: 4
tables: yes
bibliography: nrel-cables.bib
---

```{r setup, include=FALSE}
# set working directory
if (basename(getwd()) == 'nrel-cables') setwd('docs')

# load packages and variables
source('./packages_vars.R')

#opts_chunk$set(warning=F, message=F)
opts_chunk$set(warning=F, message=F, eval=T) # DEBUG
fig_type = 'png' # 'png','pdf','html'

if (interactive() || "rmarkdown.pandoc.to" %in% names(opts_knit$get()) && opts_knit$get("rmarkdown.pandoc.to") == 'html'){
  out_html = T
  #opts_chunk$set(echo=T)
  opts_chunk$set(echo=F)
} else {
  out_html = F
  opts_chunk$set(echo=F)
}

fmt_tbl = function(csv, energy_hdr, caption){

  # read_csv(csv) %>%
  #   mutate(
  #    cable2_pct = cable2_pct/100, 
  #    cable3_pct = cable3_pct/100) %>%
  #   write_csv(csv)
  
  d = read_csv(csv) %>%
    filter(
      territory != 'ALL',
      !is.na(territory))
  
  # correct for odd flipping from using className='dt-right'
  d = d %>%
    mutate(
      energy_lbl = recode(
        energy_lbl, 
        `<=7`='7=>',
        `>30`='30<',
        `>1500`='1500<'))
  
  hdr = htmltools::withTags(table(
    class = 'display',
    thead(
      tr(
        th(rowspan=2, 'Territory'),
        th(rowspan=2, energy_hdr),
        th(rowspan=2, 'Area (km2)'),
        th(colspan=2, 'Min. Cable (2z)'),
        th(colspan=2, 'Rec. Cable (3z)')),
      tr(
        th('Area (km2)'),
        th('(%)'),
        th('Area (km2)'),
        th('(%)')))))

  d %>%
    mutate(
      territory  = ifelse(duplicated(territory), '', territory),
      energy     = factor(energy_num, unique(energy_num), unique(energy_lbl)),
      area_km2   = accounting(area_km2, digits=0),
      cable2_km2 = accounting(cable2_km2, digits=0),
      cable3_km2 = accounting(cable3_km2, digits=0),
      cable2_pct = percent(cable2_pct, digits=1),
      cable3_pct = percent(cable3_pct, digits=1)) %>%
    select(
      territory, energy, area_km2,
      cable2_km2, cable2_pct, cable3_km2, cable3_pct) %>%
    formattable(
      list(
        energy     = color_bar('lightblue'),
        area_km2   = color_bar('lightgray'),
        cable2_km2 = color_bar('lightpink'),
        cable3_km2 = color_bar('lightgreen'))) %>%
    as.datatable(
      rownames=F, container=hdr, caption=caption,
      options = list(
        dom='t', # off: n_entries/search/paging/ordering
        pageLength = nrow(d), ordering=F,
        columnDefs = list(list(className='dt-right', targets=1:5))))
}

plot_cbls = function(
  csv   = wave_cbls_csv, 
  #title = 'Wave Energy by Area and Power Class per US Territory',
  xlab  = 'Wave energy (kW/m)',
  legend_position      = c(1,0),
  legend_justification = c(1,0)){ 
  
  energy_cbls = read_csv(csv) %>%
    filter(
      !is.na(territory),
      territory != 'ALL') %>%
    mutate(
      energy = factor(energy_lbl, unique(energy_lbl), ordered=T),
      pct_lbl = sprintf('%0.1f - %0.1f%%', cable2_pct*100, cable3_pct*100))
  
  #cable_ord = c('min_2d'='Minimum (2*depth)', 'rec_3d'='+Recommended (3*depth)', 'rem'='Available')
  cable_ord = c('min_2d'='Min.(2z)', 'rec_3d'='+Rec.(3z)', 'rem'='Free')
  
  d_p = energy_cbls %>%
    mutate(
      min_2d = cable2_km2,
      rec_3d = cable3_km2 - cable2_km2,
      rem    = area_km2 - cable3_km2) %>%
    select(
      territory, energy, min_2d, rec_3d, rem) %>%
    gather(type, km2, -energy, -territory) %>%
    mutate(
      type = factor(
        type,
        names(cable_ord),
       cable_ord, ordered=T)) %>%
    arrange(territory, energy, type)
  
  txt_adj = energy_cbls %>% 
    summarize(txt_adj = max(area_km2)/1000*0.025) %>% 
    .$txt_adj
  
  p = ggplot(
      data=d_p,
      aes(x = energy, y = km2/1000, fill=type)) +
    geom_col() +
    geom_text(
      data=energy_cbls, 
      aes(label=pct_lbl, x=energy, y=area_km2/1000, fill=NULL), 
      position = position_nudge(y = txt_adj), size=2) +
    labs(
      #title=title, 
      #subtitle='with Cable Overlay (Minimum - Recommended %)', 
      x=xlab, y='Area (1,000 km^2)', fill='Cable') +
    theme(
      legend.justification = legend_justification, 
      legend.position      = legend_position,
      axis.text.x = element_text(angle = 90, hjust = 1)) + 
    facet_wrap(~territory) # facet_wrap(~territory, scales='free_y') # facet_grid(. ~ territory)
  print(p)
}

fig_exists = function(fig){ 
  fig_ext = sprintf('%s.%s', fig, fig_type)
  file.exists(fig_ext)}

map_cable = function(
  ter,
  legend_title,
  redo,
  fig){
  # ter = 'Hawaii'; fig = sprintf('figs/mapCable_%s', str_replace_all(ter,' ','-')); energy_sf = wind_sf; legend_title = sprintf('Submarine cables within %s EEZ.', ter); redo = T
  
  fig_ext = sprintf('%s.%s', fig, fig_type)
  if (!file.exists(fig_ext) | redo){
    
    eez = usa_eez %>%
      filter(territory==ter)
    cables = lns_d1x %>%
      filter(territory==ter)
    cables2 = dx2 %>%
      filter(territory==ter)
    cables3 = dx3 %>%
      filter(territory==ter)
    
    bb = st_bbox(eez)
    bb_ply = st_sf(
      tibble(
        territory = ter,
        geom = st_sfc(st_polygon(list(rbind(
          c(bb['xmin'], bb['ymin']),
          c(bb['xmax'], bb['ymin']),
          c(bb['xmax'], bb['ymax']),
          c(bb['xmin'], bb['ymax']),
          c(bb['xmin'], bb['ymin'])))), crs = 4326)))
    earth = land %>%
      filter(
        st_intersects(land, bb_ply, sparse=F)[,1]) # plot(earth)

    p = ggplot(data=eez) +
      geom_sf(data=earth, fill='gray40', size=0.2, color=NA) +
      geom_sf(data=eez, fill=NA, color='gray40') +
      geom_sf(data=cables3, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables2, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables, color='red', size=0.1, alpha=0.9) +
      coord_sf(
        xlim=bb[c('xmin','xmax')], 
        ylim=bb[c('ymin','ymax')])
      
    if (fig_type=='pdf'){
      pdf(fig_ext, width=6.5, height=5)
    }  else {
      png(fig_ext)
    }
    print(p)
    dev.off()
  }
  #system(sprintf('open %s', fig))
  #knitr::include_graphics(fig)
}

map_energy_sf = function(
  energy_sf,
  ter,
  legend_title,
  redo,
  fig){
  # ter = 'Hawaii'; fig = sprintf('figs/mapWind_%s', str_replace_all(ter,' ','-')); energy_sf = wind_sf; legend_title = 'Wind\nspeed\n(m/s)'; redo = T
  
  fig_ext = sprintf('%s.%s', fig, fig_type)
  if (!file.exists(fig_ext) | redo){
    
    d = energy_sf %>% 
      filter(territory==ter)
    eez = usa_eez %>%
      filter(territory==ter)
    cables = lns_d1x %>%
      filter(territory==ter)
    cables2 = dx2 %>%
      filter(territory==ter)
    cables3 = dx3 %>%
      filter(territory==ter)
    
    bb = st_bbox(d)
    # TODO: st_cast(x=st_bbox, to=st_polygon)                 
    bb_ply = st_sf(
      tibble(
        territory = ter,
        geom = st_sfc(st_polygon(list(rbind(
          c(bb['xmin'], bb['ymin']),
          c(bb['xmax'], bb['ymin']),
          c(bb['xmax'], bb['ymax']),
          c(bb['xmin'], bb['ymax']),
          c(bb['xmin'], bb['ymin'])))), crs = 4326)))
    earth = land %>%
      filter(
        st_intersects(land, bb_ply, sparse=F)[,1]) # plot(earth)

    p = ggplot(data=d) +
      geom_sf(aes(fill=energy), color=NA) +
      scale_fill_brewer(legend_title, palette='YlGnBu', direction=-1) +
      geom_sf(data=earth, fill='gray40', size=0.2, color=NA) +
      geom_sf(data=eez, fill=NA, color='gray40') +
      geom_sf(data=cables3, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables2, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables, color='red', size=0.1, alpha=0.9) +
      coord_sf(
        xlim=bb[c('xmin','xmax')], 
        ylim=bb[c('ymin','ymax')]) +
      theme(
        legend.background = element_rect(fill='grey90'),  
        legend.key = element_blank())
      
    if (fig_type=='pdf'){
      pdf(fig_ext, width=6.5, height=5)
    }  else {
      png(fig_ext)
    }
    print(p)
    dev.off()
  }
  #system(sprintf('open %s', fig))
  #knitr::include_graphics(fig)
}

map_tide = function(
  ter,
  legend_title,
  redo,
  fig){
  # ter = 'Alaska'; fig = sprintf('figs/mapTide_%s', str_replace_all(ter,' ','-')); legend_title = 'Tidal\npower\n(W/m2)'; redo = T
  
  fig_ext = sprintf('%s.%s', fig, fig_type)
  if (!file.exists(fig_ext) | redo){
    
    ter_str = str_replace_all(ter, ' ', '-')
    tif = sprintf('../data/tide_ter-%s.tif', ter_str)
    r = raster(tif)

    #d = energy_sf %>% 
    #  filter(territory==ter)
    eez = usa_eez %>%
      filter(territory==ter)
    cables = lns_d1x %>%
      filter(territory==ter)
    cables2 = dx2 %>%
      filter(territory==ter)
    cables3 = dx3 %>%
      filter(territory==ter)
    
    bb = bbox(r)
    bb = c(xmin=bb[1,1], xmax=bb[1,2], ymin=bb[2,1], ymax=bb[2,2])
    # TODO: st_cast(x=st_bbox, to=st_polygon)                 
    bb_ply = st_sf(
      tibble(
        territory = ter,
        geom = st_sfc(st_polygon(list(rbind(
          c(bb['xmin'], bb['ymin']),
          c(bb['xmax'], bb['ymin']),
          c(bb['xmax'], bb['ymax']),
          c(bb['xmin'], bb['ymax']),
          c(bb['xmin'], bb['ymin'])))), crs = 4326)))
    earth = land %>%
      filter(
        st_intersects(land, bb_ply, sparse=F)[,1])

    # https://nrelscience.org/2013/05/30/this-is-how-i-did-it-mapping-in-r-with-ggplot2/
    d = as.data.frame(r, xy=T) %>% as_tibble()
    colnames(d) <- c('lon','lat','value')
    d = d %>% filter(!is.na(value))
    
    p = ggplot() + 
      geom_raster(data=d, aes(x=lon, y=lat, fill=value)) + 
      scale_fill_gradientn(
        legend_title,
        colours=rev(brewer.pal(11,'YlGnBu')),
        limits=c(0,cellStats(r, 'max')),
        na.value = 'transparent') +
      geom_sf(data=earth, fill='gray40', size=0.2, color=NA) +
      geom_sf(data=eez, fill=NA, color='gray40') +
      geom_sf(data=cables3, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables2, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables, color='red', size=0.1, alpha=0.9) +
      coord_sf(
        xlim=bb[c('xmin','xmax')], 
        ylim=bb[c('ymin','ymax')]) +
      theme(
        legend.background = element_rect(fill='grey90'),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),  
        legend.key = element_blank())
      
    if (fig_type=='pdf'){
      pdf(fig_ext, width=6.5, height=5)
    }  else {
      png(fig_ext)
    }
    print(p)
    dev.off()
    
  }
  #system(sprintf('open %s', fig))
  #knitr::include_graphics(fig_ext, auto_pdf=F)
}

# revert to old red-green-blue default color, not new viridis
#   per https://github.com/tidyverse/ggplot2/blob/00ecd3670ef0f1c195bf4c6b5ada3b1895712f1c/NEWS.md#ggplot2-2219000
scale_fill_ordinal = scale_fill_hue

#usa2    = wrld2 %>% filter(ID=='USA')
wrld2   = st_as_sf(map('world2', plot=F, fill=T))
usa_eez = read_sf(usa_rgn_geo)
land    = read_sf(land_usaeez_geo)
lns_d1x = read_sf(lns_d1x_rgn_geo)
dx2     = read_sf(dx2_geo)
dx3     = read_sf(dx3_geo)
```

# Background

Demand for abundant and diverse resources in the oceans is growing, necessitating marine spatial planning. To inform development of Marine Hydrokinetic (MHK) and Offshore Wind (OSW) resources, DOE has asked NREL to identify — and mitigate where possible — the competing uses between MHK/OSW technologies and subsea power/telecoms cables. The first step in this work is to identify and quantify the overlap between the MHK/OSW resource availability and existing cable routes. Several publicly available data layers are available that identify cable routes (e.g. MarineCadastre.gov currently hosts an offshore cables geographical information system (GIS) data layer) and MHK/OSW resource density (MHK Atlas, Wind Prospector). The cable route linear features, however, do not indicate the setback distance necessary to accommodate subsea cable maintenance requirements. Preliminary work was done within NREL to evaluate the influence of subsea cable setback distance on the overlap with MHK/OSW for the west coast of the U.S [@amante_offshore_2016]. Industry reports [@communicationssecurityreliabilityandinteroperabilitycounciliv_clustering_2016; @communicationssecurityreliabilityandinteroperabilitycounciliv_protection_2014] from the International Cable Protection Committee (ICPC) of the North American Submarine Cable Association (NASCA; [n-a-s-c-a.org](https://www.n-a-s-c-a.org/)) advise on setback distances that inform this analysis.

# Methods

## Study Area and Submarine Cables

The study area included the 200 nm extent of US waters downloaded from MarineRegions.org ^[MarineRegions.org US exclusive economic zone (EEZ) data, version World_EEZ_v9_20161021] and overlapping the offshore cable data layer available through MarineCadastre.gov ^[MarineCadastre.gov cable metadata: https://coast.noaa.gov/dataservices/Metadata/TransformMetadata?u=https://coast.noaa.gov/data/Documents/Metadata/harvest/MarineCadastre/NOAAChartedSubmarineCables.xml&f=html]. See Figure \@ref(fig:mapStudyArea).

TODO: add citations to bibliography:

- [MarineRegions.org](http://marineregions.org/downloads.php) > Exclusive Economic Zones Boundaries (EEZ), version: World EEZ v9 (2016-10-21, 123 MB). Suggested citation:

    - Flanders Marine Institute (2016). Maritime Boundaries Geodatabase, version 1. Available online at http://www.marineregions.org/. Consulted on 2017-04-25.

- [MarineCadastre.gov cable metadata](https://coast.noaa.gov/dataservices/Metadata/TransformMetadata?u=https://coast.noaa.gov/data/Documents/Metadata/harvest/MarineCadastre/NOAAChartedSubmarineCables.xml&f=html)

See Table 1 and Figure \@ref(fig:mapCablesTerritories).

```{r tblTerritories}
usa = read_sf(usa_rgn_s_geo)
st_geometry(usa) = NULL # drop geometry column

tbl = usa %>%
  arrange(territory) %>%
  mutate(
    Id         = row_number(),
    area_km2   = accounting(area_km2, digits=0)) %>%
  select(
    Id, Territory=territory, `Area (km2)`=area_km2)

tbl %>%
  formattable(list(
    `Area (km2)` = color_bar('lightgray'))) %>%
  as.datatable(
    rownames = F, 
    caption  = 'Table 1: Territories within the United States exclusive economic zone (EEZ) and having submarine cables.',
    options  = list(
      dom='t', # off: n_entries/search/paging/ordering
      pageLength = nrow(tbl), ordering=F,
      columnDefs = list(list(className='dt-right', targets=c(0,2)))))
```

```{r mapCableTerritories, fig.cap='Map of NOAA Charted Submarine cables as of December 2012 within the exclusive economic zone (EEZ; 200 nm) of United States territories.'}
fig = 'figs/mapCableTerritories' # redo=T
fig_ext = sprintf('%s.%s', fig, fig_type) # redo=T
if (!file.exists(fig_ext) | redo){

  cables = read_sf(lns_geo) %>%                      # cables
    mutate(
      geometry = (geometry + c(360,90)) %% c(360) - c(0,90)) %>%
    st_set_crs(crs_gcs_w)
  eez    = read_sf(usa_rgn_s_geo) %>%                # eez territories
    arrange(territory) %>%
    mutate(
      id        = row_number(),
      territory = factor(territory, territory, label=sprintf('%d.%s', id, territory)),
      pt_geom   = st_centroid(geometry),
      x         = sapply(pt_geom, "[[", 1),
      y         = sapply(pt_geom, "[[", 2))
  land   = st_as_sf(map('world2', plot=F, fill=T))   # land
  
  bb = st_bbox(cables)
  col_n  = length(eez$territory)
  col_pal = colorRampPalette(brewer.pal(11,'Spectral'))(col_n)
  
  p = ggplot(eez) +
    geom_sf(aes(fill=territory), color=NA, alpha=0.4) +
    scale_fill_manual('US Territory', values = col_pal) +
    geom_sf(data=cables, color='red', size=0.1, alpha=0.9) +
    geom_sf(data=wrld2, fill='gray60', color='gray80') +
    geom_text(data=eez, aes(x,y,label=id), color='black') +
    coord_sf(
      xlim=bb[c('xmin','xmax')], 
      ylim=bb[c('ymin','ymax')]) +
    theme(
      legend.background = element_rect(fill='grey90'),  
      legend.key = element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())

  if (fig_type=='pdf'){
    pdf(fig_ext, width=6.5, height=5)
  }  else {
    png(fig_ext)
  }
  print(p)
  dev.off()
  #system(sprintf('open %s', fig))
}
knitr::include_graphics(fig_ext, auto_pdf=F)
```


## Depth

The bathymetric depth comes from the [GEBCO 30 arc-second grid](http://www.gebco.net/data_and_products/gridded_bathymetry_data/gebco_30_second_grid/). Here's there requested attribution:

**GEBCO_2014 Grid, version 20150318, www.gebco.net**

## Renewable Energy

NREL.

## Avoidance Zones for Siting New Facilities

"ICPC Recommendation 13 No. 2, which establishes a methodology for determining site-specific proximity limits between submarine cables and offshore wind facilities and a default separation distance in shallower waters of 500 meters on either side of an in-service submarine cable — a separation standard the principles of which also apply to other offshore renewable energy projects."

"Subsea Cables UK Guideline No. 6 (endorsed by NASCA), which establishes principles for determining safe proximity distances and negotiating proximity agreements between offshore wind farms and submarine cables and reflects extensive experience in the United Kingdom with managing spatial conflicts between offshore wind farms and submarine cables."

"endorse a default separation distance of 500 meters in water depths of less than 75 meters and the greater of 500 meters or two times the depth of water in greater water depths."

1. **Default separation distance** by depth:
    - `<= 250 m`: 500 m
    - `> 250 m`: 2 x depth

Psudocode:

```
# buffer based on depth
cables_buffers = list()
for (x in unique(cable_cells$depth)){

  cables_buffers[str(x)] = cable_cells %>%
    subset(depth == x) %>%
    buffer(x)

}
cable_buf = merge(cables_buffers)

# smooth out jagged edges between cells
cable_buf = simplify(cable_buf)
```

## Separation Zones for Routing New Cables

"ICPC Recommendation 2 No. 10: parallel submarine cables maintain a separation distance of the lesser of 3 times depth of water or (where not achievable) 2 times the depth of water following consultation and agreement between affected parties — a separation standard the principles of which also apply to spacing of submarine cables and other marine infrastructure"

At least 2 separation zones based on depth:

1. **Minimum**:  2 times the depth of water

1. **Recommended**: 3 times depth of water

Psudocode:

```
# convert depth (GEBCO 30 sec resolution) to polygons of cells
depth_cells = as.polygon(depth_raster)

# intersect cables with depth cells
cable_cells = intersect(cables_lines, depth_cells)

# buffer based on depth
cables_buffers = list()
for (x in unique(cable_cells$depth)){

  cables_buffers[str(x)] = cable_cells %>%
    subset(depth == x) %>%
    buffer(x)

}
cable_buf = merge(cables_buffers)

# smooth out jagged edges between cells
cable_buf = simplify(cable_buf)
```

## Depth-Varying Cable Buffer

A depth-varying buffer to the offshore cables, 2 \* depth for "minimum" and 3 \* depth for "recommended" separation zones for routing new cables, by first intersecting depth with cables, then iterating over each depth to apply the appropriate buffers before finally dissolving all buffers. In order to apply the buffer, I needed to project from geographic coordinates to a projection that minimizes area distortion, so chose Albers Equal Area and applied the ["one-sixth rule"]( http://desktop.arcgis.com/en/arcmap/latest/map/projections/albers-equal-area-conic.htm#GUID-2158C4F9-F197-458E-94F0-84933C1BE6B7) based on the extent of the cable features to minimize distortion.

# Results

## Cable Buffer

```{r mapCableBuffers, fig.cap='Map of submarine cable buffers within the exclusive economic zone (EEZ; 200 nm) of United States territories. In order to see the area covered by the buffers, please visit the Detailed Maps section.'}
fig = 'figs/mapCableBuffers'
fig_ext = sprintf('%s.%s', fig, fig_type) # redo=T
if (!file.exists(fig_ext) | redo){

  cables = read_sf(lns_rgn_geo) %>%                      # cables
    mutate(
      geometry = (geometry + c(360,90)) %% c(360) - c(0,90)) %>%
    st_set_crs(crs_gcs_w)
  cables2 = read_sf(dx2_geo)
  cables3 = read_sf(dx3_geo)
  eez    = read_sf(usa_rgn_s_geo) %>%                # eez territories
    arrange(territory) %>%
    mutate(
      id        = row_number(),
      territory = factor(territory, territory, label=sprintf('%d.%s', id, territory)),
      pt_geom   = st_centroid(geometry),
      x         = sapply(pt_geom, "[[", 1),
      y         = sapply(pt_geom, "[[", 2))
  land   = st_as_sf(map('world2', plot=F, fill=T))   # land
  
  bb = st_bbox(cables)
  col_n  = length(eez$territory)
  col_pal = colorRampPalette(brewer.pal(11,'Spectral'))(col_n)
  
  p = ggplot(eez) +
    #geom_sf(aes(color=territory), fill=NA, alpha=0.4) +
    geom_sf(aes(color=territory), size=0.3, fill=NA) +
    #scale_fill_manual('US Territory', values = col_pal) +
    scale_color_manual('US Territory', values = alpha(col_pal, 0.8)) +
    geom_sf(data=cables3, fill='red', color=NA, alpha=0.15) +
    geom_sf(data=cables2, fill='red', color=NA, alpha=0.15) +
    geom_sf(data=cables, color='red', size=0.1, alpha=0.9) +
    geom_sf(data=wrld2, fill='gray60', color='gray80') +
    #geom_text(data=eez, aes(x,y,label=id), color='black') +
    coord_sf(
      xlim=bb[c('xmin','xmax')], 
      ylim=bb[c('ymin','ymax')]) +
    theme(
      legend.background = element_rect(fill='grey90'),  
      legend.key = element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())

  if (fig_type=='pdf'){
    pdf(fig_ext, width=6.5, height=5)
  }  else {
    png(fig_ext)
  }
  print(p)
  dev.off()
  #system(sprintf('open %s', fig))
}
knitr::include_graphics(fig_ext, auto_pdf=F)
```


Generated by:

- [create_cable-buffer.R](https://github.com/ecoquants/nrel-cables/blob/master/docs/create_cable-buffer.R)

- [extract_cable-energy.R](https://github.com/ecoquants/nrel-cables/blob/master/docs/extract_cable-energy)

Google Earth files (*.kml):

- [buf_2xdepth-incr100m.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/buf_2xdepth-incr100m.kml)

- [buf_3xdepth-incr100m.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/buf_3xdepth-incr100m.kml)

- [lns_d1x.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/lns_d1x.kml)

## Overlap of Cable Buffer with Renewable Energy

Extract average and area of overlap between zones and renewable energy potential areas, possibly at various depth bins.

```{r pltEnergy, fig.cap='Energy by area and power class per US territory with cable overlay (minimum - recommended %).'}
read_cbls = function(csv, form){
  read_csv(csv) %>%
    filter(
      territory == 'ALL') %>%
    mutate(
      form    = form,
      #energy  = factor(energy_lbl, unique(energy_lbl), ordered=T),
      pct_lbl = sprintf('%0.1f - %0.1f%%', cable2_pct*100, cable3_pct*100))
}

tbl_form_cbls = map2(
  c(wind_cbls_csv, wave_cbls_csv, tide_cbls_csv), 
  c('wind','wave','tide'), 
  read_cbls) %>%
  bind_rows() %>%
  mutate(
    energy = factor(
      x      = sprintf('%s_%04d', form, energy_num), 
      levels = sprintf('%s_%04d', form, energy_num), 
      label  = energy_lbl, ordered=T))

cable_ord = c('min_2d'='Min.(2z)', 'rec_3d'='+Rec.(3z)', 'rem'='Free')
  
d_p = tbl_form_cbls %>%
  mutate(
    min_2d = cable2_km2,
    rec_3d = cable3_km2 - cable2_km2,
    rem    = area_km2 - cable3_km2) %>%
  select(
    form, energy, min_2d, rec_3d, rem) %>%
  gather(type, km2, -energy, -form) %>%
  mutate(
    type = factor(
      type,
      names(cable_ord),
      cable_ord, ordered=T)) %>%
  arrange(form, energy, type)

txt_adj = tbl_form_cbls %>% 
  summarize(txt_adj = max(area_km2)/1000*0.025) %>% 
  .$txt_adj

p = ggplot(
  data=d_p,
  aes(x = energy, y = km2/1000, fill=factor(type))) +
  #scale_fill_brewer(palette = 'Spectral') +
  geom_col() +
  geom_text(
    data=tbl_form_cbls, 
    aes(label=pct_lbl, x=energy, y=area_km2/1000, fill=NULL), 
    position = position_nudge(y = txt_adj), size=2) +
  labs(
    #title    = 'Energy by Area and Power Class per US Territory', 
    #subtitle = 'with Cable Overlay (Minimum - Recommended %)', 
    x='Energy', y='Area (1,000 km^2)', fill='Cable') +
  theme(
    legend.justification = c(1,1), 
    legend.position      = c(1,1),
    axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_wrap(~form, scales='free_x')
print(p)
```

```{r tblEnergy}
d = tbl_form_cbls
energy_hdr = 'Amount'
caption = 'Table 2: Area overlap with cables by form of energy broken into size classes across all territories.'

# update energy column for proportion in color_box
e_lbls = c(
    '7=>','7-8',  '8-9','9-10','10-11','11-12', #  1:6
   '0-10',   '10-20',    '20-30',  '30<',       #  7:10
  '0-500','500-1000','1000-1500','1500<')       # 11:14
e_idx = c(1,7,11, 2,8,12, 3, 4,9,13, 5,10,14, 6) # setdiff(1:length(e_lbls), e_idx) 
e_lkup = setNames(e_idx, 1:14)
d = d %>% 
  mutate(
    form = ifelse(
      duplicated(form), '',       c(
        'tide'='Tidal Power (W/m2)',
        'wave'='Wave Energy (kW/m)',
        'wind'='Wind Speed (m/s)')[d$form]),
    energy = factor(
      x = e_lkup %>% sort() %>% names %>% as.integer,
      levels = 1:14,
      labels = e_lbls[e_idx],
      ordered=T),
    area_km2   = accounting(area_km2, digits=0),
    cable2_km2 = accounting(cable2_km2, digits=0),
    cable3_km2 = accounting(cable3_km2, digits=0),
    cable2_pct = percent(cable2_pct, digits=1),
    cable3_pct = percent(cable3_pct, digits=1)) %>%
  select(
    form, energy, area_km2,
    cable2_km2, cable2_pct, cable3_km2, cable3_pct)

hdr = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan=2, 'Energy'),
      th(rowspan=2, 'Area (km2)'),
      th(colspan=2, 'Min. Cable (2z)'),
      th(colspan=2, 'Rec. Cable (3z)')),
    tr(
      th('Form'),
      th('Amount'),
      th('Area (km2)'),
      th('(%)'),
      th('Area (km2)'),
      th('(%)')))))

d %>%
  formattable(
    list(
      energy     = color_bar('lightblue'),
      area_km2   = color_bar('lightgray'),
      cable2_km2 = color_bar('lightpink'),
      cable3_km2 = color_bar('lightgreen'))) %>%
  as.datatable(
    rownames=F, container=hdr, 
    caption = caption,
    options = list(
      dom='t', # off: n_entries/search/paging/ordering
      pageLength = nrow(d), ordering=F,
      columnDefs = list(list(className='dt-right', targets=1:5))))
```

### Tidal

units: mean power (W/m^2)

```{r pltTide, fig.cap='Tidal power (W/m2) and area per US territory with cable overlay (minimum - recommended %).'}
plot_cbls(
  csv   = tide_cbls_csv, 
  #title = 'Tidal Energy by Area and Power Class per US Territory',
  xlab  = 'Tidal power (W/m2)',
  legend_position      = c(1,1),
  legend_justification = c(1,1))
```

```{r tblTide}
fmt_tbl(
  csv        = tide_cbls_csv, 
  energy_hdr = 'Tidal power (W/m2)',
  caption    = 'Table 5: Area overlap with cables for tidal power (W/m2) by territory.')
```

### Wave

units: wave energy flux (kW/m)

```{r pltWave, fig.cap='Wave energy (kW/m) and area per US territory with cable overlay (minimum - recommended %).'}
plot_cbls(
  csv   = wave_cbls_csv,
  #title = 'Wave Energy by Area and Power Class per US Territory',
  xlab  = 'Wave energy (kW/m)')
```

```{r tblWave}
fmt_tbl(
  csv        = wave_cbls_csv, 
  energy_hdr = 'Wave Energy (kW/m)',
  caption    = 'Table 4: Area overlap with cables for wave energy (kW/m) by territory.')
```

### Wind

units: wind speed (m/s) at 90m hub height

```{r pltWind, fig.cap='Wind speed (m/s) and area per US territory with cable overlay (minimum - recommended %).'}
plot_cbls(
  csv   = wind_cbls_csv, 
  #title = 'Wind Energy by Area and Power Class per US Territory',
  xlab  = 'Wind speed (m/s)',
  # legend_position      = c(0,0.47),
  # legend_justification = c(0,1))
  legend_justification = c(1,1), 
  legend_position      = c(1,1))
```

```{r tblWind}
fmt_tbl(
  csv=wind_cbls_csv, energy_hdr='Wind Speed (m/s)',
  caption='Table 3: Area overlap with cables for wind speed (m/s) at 90m hub height by territory.')
```

## Detailed Maps by US Territory of Cable Buffer and Renewable Energy

```{r mapCable, fig.cap='Maps of tidal energy.'}
for (ter in sort(unique(lns_d1x$territory))){ # ter = 'Hawaii'
  fig = sprintf('figs/mapCable_%s', str_replace_all(ter,' ','-'))
  map_cable(
    ter = ter,
    fig = fig,
    redo = F)
  #system(sprintf('open %s', fig))
}
#knitr::include_graphics(sprintf('figs/mapCable_%s.pdf', str_replace_all(unique(lns_d1x$territory),' ','-')))
```

```{r mapTide, fig.cap='Maps of tidal energy.'}
territories = read_csv(tide_cbls_csv) %>% 
  filter(territory !='ALL') %>% 
  .$territory %>% unique()

for (ter in territories){ # ter = 'Hawaii'
  map_tide(
    ter = ter,
    legend_title = 'Tidal\npower\n(W/m2)',
    fig = sprintf('figs/mapTide_%s', str_replace_all(ter,' ','-')),
    redo = F)
  #system(sprintf('open %s', fig))
}
#knitr::include_graphics(sprintf('figs/mapTide_%s.pdf', str_replace_all(territories,' ','-')))
```

```{r mapWave, fig.cap='Maps of wave energy.'}
wave_sf = read_sf(wave_geo) %>%
  filter(!is.na(territory)) %>%
  mutate(
    energy = factor(
      energy_num, unique(energy_num), unique(energy_lbl), ordered=T))

for (ter in unique(wave_sf$territory)){ # ter = 'Hawaii'
  map_energy_sf(
    energy_sf = wave_sf,
    ter = ter,
    legend_title = 'Wave\nenergy\n(kW/m)',
    redo = F,
    fig = sprintf('figs/mapWave_%s', str_replace_all(ter,' ','-')))
  #system(sprintf('open %s', fig))
  #knitr::include_graphics(fig)
}
#knitr::include_graphics(sprintf('figs/mapWave_%s.pdf', str_replace_all(unique(wave_sf$territory),' ','-')))
```

```{r mapWind, fig.cap='Maps of wind energy.'}
wind_sf = read_sf(wind_geo) %>%
  arrange(energy_num) %>%
  mutate(
    energy = factor(
      energy_num, unique(energy_num), unique(energy_lbl), ordered=T)) %>%
  arrange(region, energy)

for (ter in unique(wind_sf$territory)){ # ter = 'Hawaii'
  map_energy_sf(
    energy_sf = wind_sf,
    ter = ter,
    legend_title = 'Wind\nspeed\n(m/s)',
    redo = F,
    fig = sprintf('figs/mapWind_%s', str_replace_all(ter,' ','-')))
  #system(sprintf('open %s', fig))
  #knitr::include_graphics(fig)
}
#knitr::include_graphics(sprintf('figs/mapWind_%s.pdf', str_replace_all(unique(wind_sf$territory),' ','-')))
```

```{r srcTerritoryTemplate, include=F}
src = lapply(
  sort(unique(lns_d1x$territory)), 
  function(
    ter,
    ter_hyp   = str_replace_all(ter, ' ', '-'),
    ter_str   = str_replace_all(ter, ' ', ''),
    map_cable = sprintf('figs/mapCable_%s.%s', ter_hyp, fig_type),
    map_tide  = sprintf('figs/mapTide_%s.%s', ter_hyp, fig_type),
    map_wave  = sprintf('figs/mapWave_%s.%s', ter_hyp, fig_type),
    map_wind  = sprintf('figs/mapWind_%s.%s', ter_hyp, fig_type),
    has_tide  = file.exists(map_tide),
    has_wave  = file.exists(map_wave),
    has_wind  = file.exists(map_wind)){
      knit_expand(file='territory_template.Rmd')})
# write_lines(src, 'test_src.Rmd')
```

`r knit(text = unlist(src))`

# Conclusions

## Next Steps

- stacked histogram by cbl2/(cbl3-cbl2)/other; hist(wind$Speed_90)

- simplify as native geojson

Musial et al (2016):

- wind speed (m/s) -- Table A-3 (p. 48): <7, 7-8, 8-9, 9-10, 10-11, total

- depth classes (m) -- Table B-1 (p. 49): <30, 30-60, 60-700, 700-1000, >1000, total

- distance to shore (nm) -- Table B-2 (p. 50): <3, 3-12, 12-50, 50-200, total

- by states

## Communication with Stakeholders

Products will be online and readily digestable by stakeholders.

# References
