---
title: "Submarine Cable Analysis for Marine Renewable Energy Development"
csl: apa.csl
output:
  bookdown::pdf_document2:
    keep_tex: yes
    toc: yes
  bookdown::html_document2:
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
  bookdown::word_document2:
    toc: yes
tables: yes
bibliography: nrel-cables.bib
---

```{r setup, include=FALSE, eval=T}
# set working directory
if (basename(getwd()) == 'nrel-cables') setwd('docs')

# load packages and variables
source('./packages_vars.R')

#opts_chunk$set(warning=F, message=F)
opts_chunk$set(warning=F, message=F, eval=T) # DEBUG

if (interactive() || "rmarkdown.pandoc.to" %in% names(opts_knit$get()) && opts_knit$get("rmarkdown.pandoc.to") == 'html'){
  out_html = T
  #opts_chunk$set(echo=T)
  opts_chunk$set(echo=F)
} else {
  out_html = F
  opts_chunk$set(echo=F)
}
```

# Background

Demand for abundant and diverse resources in the oceans is growing, necessitating marine spatial planning. To inform development of Marine Hydrokinetic (MHK) and Offshore Wind (OSW) resources, DOE has asked NREL to identify — and mitigate where possible — the competing uses between MHK/OSW technologies and subsea power/telecoms cables. The first step in this work is to identify and quantify the overlap between the MHK/OSW resource availability and existing cable routes. Several publicly available data layers are available that identify cable routes (e.g. MarineCadastre.gov currently hosts an offshore cables geographical information system (GIS) data layer) and MHK/OSW resource density (MHK Atlas, Wind Prospector). The cable route linear features, however, do not indicate the setback distance necessary to accommodate subsea cable maintenance requirements. Preliminary work was done within NREL to evaluate the influence of subsea cable setback distance on the overlap with MHK/OSW for the west coast of the U.S [@amante_offshore_2016]. Industry reports [@communicationssecurityreliabilityandinteroperabilitycounciliv_clustering_2016; @communicationssecurityreliabilityandinteroperabilitycounciliv_protection_2014] from the International Cable Protection Committee (ICPC) of the North American Submarine Cable Association (NASCA; [n-a-s-c-a.org](https://www.n-a-s-c-a.org/)) advise on setback distances that inform this analysis.

# Methods

## Study Area and Submarine Cables

The study area included the 200 nm extent of US waters downloaded from MarineRegions.org ^[MarineRegions.org US exclusive economic zone (EEZ) data, version World_EEZ_v9_20161021] and overlapping the offshore cable data layer available through MarineCadastre.gov ^[MarineCadastre.gov cable metadata: https://coast.noaa.gov/dataservices/Metadata/TransformMetadata?u=https://coast.noaa.gov/data/Documents/Metadata/harvest/MarineCadastre/NOAAChartedSubmarineCables.xml&f=html]. See Figure \@ref(fig:mapStudyArea).

TODO: add citations to bibliography:

- [MarineRegions.org](http://marineregions.org/downloads.php) > Exclusive Economic Zones Boundaries (EEZ), version: World EEZ v9 (2016-10-21, 123 MB). Suggested citation:

    - Flanders Marine Institute (2016). Maritime Boundaries Geodatabase, version 1. Available online at http://www.marineregions.org/. Consulted on 2017-04-25.

- [MarineCadastre.gov cable metadata](https://coast.noaa.gov/dataservices/Metadata/TransformMetadata?u=https://coast.noaa.gov/data/Documents/Metadata/harvest/MarineCadastre/NOAAChartedSubmarineCables.xml&f=html)

See Table \@ref(tab:tblDataSources).

```{r tblDataSources, eval=T}
read_csv('../data/data_sources.csv') %>%
  kable(
    caption = 'Data sources from preliminary report.') # , booktabs=T)
```

## tbl_eez-usa

```{r tblUSATerrritories, eval=T}
usa = read_sf(usa_rgn_s_geo)

usa_tbl = usa %>%
  as_tibble() %>%
  select(territory, area_km2)

if (out_html){
  usa_tbl %>%
    datatable(options = list(pageLength=nrow(usa_tbl), dom='t')) %>%
    formatCurrency(
      c('area_km2'), 
      currency = "", interval = 3, mark = ",", digits=1)
} else {
  usa_tbl %>%
    kable(caption = 'EEZ parts for USA.') # , booktabs=T)
}
```

```{r mapStudyArea, eval=T, fig.cap='Map of NOAA Charted Submarine cables in the United States as of December 2012.'}
lns_rgn = read_sf(lns_rgn_geo)

pal <- colorFactor(
  colorRampPalette(brewer.pal(11,'Spectral'))(length(usa$territory)),
  usa$territory)

m = leaflet(usa) %>%
  addProviderTiles('Esri.OceanBasemap') %>%
  addPolylines(
    data = lns_rgn, group='cables',
    color='black', opacity = 1, weight=1,
    popup = ~sprintf(
      "scaleBand: %s<br>description: %s<br>effectiveDate: %s",
      scaleBand, description, effectiveDate)) %>%
  addPolygons(
   label = ~sprintf('%s', territory),
   color = ~pal(territory)) #%>%
if (out_html){
  m
} else {
  # [How to save Leaflet in R map as png or jpg file? - Stack Overflow](https://stackoverflow.com/questions/31336898/how-to-save-leaflet-in-r-map-as-png-or-jpg-file)
  m_html = '../tmp/mapStudyArea.html'
  m_png  = '../tmp/mapStudyArea.png'
  saveWidget(m, m_html, selfcontained=F)
  webshot(m_html, file=m_png, cliprect="viewport")
}
```

TODO:

* [python - Shapely polygons crossing the antimeridian - Geographic Information Systems Stack Exchange](https://gis.stackexchange.com/questions/226605/shapely-polygons-crossing-the-antimeridian)
* [r - Use different center than the prime meridian in plotting a world map - Stack Overflow](https://stackoverflow.com/questions/10620862/use-different-center-than-the-prime-meridian-in-plotting-a-world-map)
* [ogr - How to change shapefile longitude from -180 - 180 to 0 - 360? - Geographic Information Systems Stack Exchange](https://gis.stackexchange.com/questions/79447/how-to-change-shapefile-longitude-from-180-180-to-0-360)
* [sf::st_transform not honoring +lon_wrap · Issue #280 · edzer/sfr](https://github.com/edzer/sfr/issues/280)
* [Moving The Earth (well, Alaska & Hawaii) With R | rud.is](https://rud.is/b/2014/11/16/moving-the-earth-well-alaska-hawaii-with-r/)
* [Administrative Maps and Projections in R - AriLamstein.com](https://www.arilamstein.com/blog/2015/07/23/administrative-level-1-maps-and-projections/)
* [Mapping Data in R · Adam Olson](http://adamolson.org/2015/07/15/post_about_maps/)
* [Mapping All Fifty U.S. States](https://cran.r-project.org/web/packages/fiftystater/vignettes/fiftystater.html)
* [fiftystater/make_mapfile.R at master · wmurphyrd/fiftystater](https://github.com/wmurphyrd/fiftystater/blob/master/data-raw/make_mapfile.R)
* [Mapping All Fifty U.S. States](https://cran.r-project.org/web/packages/fiftystater/vignettes/fiftystater.html)
* [r - Relocating Alaska and Hawaii on thematic map of the USA with ggplot2 - Stack Overflow](https://stackoverflow.com/questions/13757771/relocating-alaska-and-hawaii-on-thematic-map-of-the-usa-with-ggplot2/13767984#13767984)
* [ohiprep/model_create_regions.py at 66bcf4e39b63b154437dda55aec6ed825ac47f05 · OHI-Science/ohiprep](https://github.com/OHI-Science/ohiprep/blob/66bcf4e39b63b154437dda55aec6ed825ac47f05/globalprep/spatial/NCEAS-Regions_v2014/model_create_regions.py)

## Depth

The bathymetric depth comes from the [GEBCO 30 arc-second grid](http://www.gebco.net/data_and_products/gridded_bathymetry_data/gebco_30_second_grid/). Here's there requested attribution:

**GEBCO_2014 Grid, version 20150318, www.gebco.net**

## Renewable Energy

NREL.

## Avoidance Zones for Siting New Facilities

"ICPC Recommendation 13 No. 2, which establishes a methodology for determining site-specific proximity limits between submarine cables and offshore wind facilities and a default separation distance in shallower waters of 500 meters on either side of an in-service submarine cable — a separation standard the principles of which also apply to other offshore renewable energy projects."

"Subsea Cables UK Guideline No. 6 (endorsed by NASCA), which establishes principles for determining safe proximity distances and negotiating proximity agreements between offshore wind farms and submarine cables and reflects extensive experience in the United Kingdom with managing spatial conflicts between offshore wind farms and submarine cables."

"endorse a default separation distance of 500 meters in water depths of less than 75 meters and the greater of 500 meters or two times the depth of water in greater water depths."

1. **Default separation distance** by depth:
    - `<= 250 m`: 500 m
    - `> 250 m`: 2 x depth

Psudocode:

```
# buffer based on depth
cables_buffers = list()
for (x in unique(cable_cells$depth)){

  cables_buffers[str(x)] = cable_cells %>%
    subset(depth == x) %>%
    buffer(x)

}
cable_buf = merge(cables_buffers)

# smooth out jagged edges between cells
cable_buf = simplify(cable_buf)
```

## Separation Zones for Routing New Cables

"ICPC Recommendation 2 No. 10: parallel submarine cables maintain a separation distance of the lesser of 3 times depth of water or (where not achievable) 2 times the depth of water following consultation and agreement between affected parties — a separation standard the principles of which also apply to spacing of submarine cables and other marine infrastructure"

At least 2 separation zones based on depth:

1. **Minimum**:  2 times the depth of water

1. **Recommended**: 3 times depth of water

Psudocode:

```
# convert depth (GEBCO 30 sec resolution) to polygons of cells
depth_cells = as.polygon(depth_raster)

# intersect cables with depth cells
cable_cells = intersect(cables_lines, depth_cells)

# buffer based on depth
cables_buffers = list()
for (x in unique(cable_cells$depth)){

  cables_buffers[str(x)] = cable_cells %>%
    subset(depth == x) %>%
    buffer(x)

}
cable_buf = merge(cables_buffers)

# smooth out jagged edges between cells
cable_buf = simplify(cable_buf)
```

## Depth-Varying Buffer

A depth-varying buffer to the offshore cables, 2 \* depth for "minimum" and 3 \* depth for "recommended" separation zones for routing new cables, by first intersecting depth with cables, then iterating over each depth to apply the appropriate buffers before finally dissolving all buffers. In order to apply the buffer, I needed to project from geographic coordinates to a projection that minimizes area distortion, so chose Albers Equal Area and applied the ["one-sixth rule"]( http://desktop.arcgis.com/en/arcmap/latest/map/projections/albers-equal-area-conic.htm#GUID-2158C4F9-F197-458E-94F0-84933C1BE6B7) based on the extent of the cable features to minimize distortion.

```{r mapCableBuffs}
dx2     = read_sf(dx2_geo)
dx3     = read_sf(dx3_geo)
lns_d1x = read_sf(lns_d1x_rgn_geo)

m = leaflet() %>%
  addProviderTiles("Stamen.TonerLite", group = "B&W") %>%
  addProviderTiles('Esri.OceanBasemap', group = "Ocean") %>%  #
  addPolygons(
    data = dx2, group='buffer: 2*depth',
    color='red', stroke=F, fillOpacity = 0.5) %>%
  addPolygons(
    data = dx3, group='buffer: 3*depth',
    color='red', stroke=F, fillOpacity = 0.5) %>%
  addPolylines(
    data = lns_d1x, group='cables',
    color='black', opacity = 1, weight=1,
    popup = ~sprintf(
      "scaleBand: %s<br>description: %s<br>effectiveDate: %s<br>Territory: %s<br>Buffer (1x): %d",
      scaleBand, description, effectiveDate, territory, buf1x)) %>%
  addLayersControl(
    baseGroups = c("B&W", "Ocean"),
    overlayGroups = c('buffer: 3*depth', 'buffer: 2*depth', 'cables'),
    options = layersControlOptions(collapsed = FALSE))

if (out_html){
  m
} else {
  # [How to save Leaflet in R map as png or jpg file? - Stack Overflow](https://stackoverflow.com/questions/31336898/how-to-save-leaflet-in-r-map-as-png-or-jpg-file)
  m_html = '../tmp/mapCableBuffs.html'
  m_png  = '../tmp/mapCableBuffs.png'
  saveWidget(m, m_html, selfcontained=F)
  webshot(m_html, file=m_png, cliprect="viewport")
}
```

# Results

Generated by:

- [create_cable-buffer.R](https://github.com/ecoquants/nrel-cables/blob/master/docs/create_cable-buffer.R)

- [extract_cable-energy.R](https://github.com/ecoquants/nrel-cables/blob/master/docs/extract_cable-energy)

Google Earth files (*.kml):

- [buf_2xdepth-incr100m.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/buf_2xdepth-incr100m.kml)

- [buf_3xdepth-incr100m.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/buf_3xdepth-incr100m.kml)

- [lns_d1x.kml](https://github.com/ecoquants/nrel-cables/raw/master/data/lns_d1x.kml)

## Overlay with Renewable Energy from NREL

Extract average and area of overlap between zones and renewable energy potential areas, possibly at various depth bins.

### Wind

units: wind speed (m/s) at 90m hub height

TODO:
- [Visualise sf objects — ggsf • ggplot2](http://ggplot2.tidyverse.org/reference/ggsf.html)

```{r mapWind, eval=F}
wind = read_sf(wind_geo)

wind %>% as('Spatial') %>%
  spplot(.[''])
```


```{r tbl-wind}
wind_cbls = read_csv(wind_cbls_csv)

wind_tbl = wind_cbls %>%
  select(-energy_num) %>%
  rename(`speed m/s`=energy_lbl) %>%
  mutate(
   pct_region         = pct_region/100,
   cable2_pct         = cable2_pct/100,
   cable2_pct_region  = cable2_pct_region/100,
   cable3_pct         = cable3_pct/100,
   cable3_pct_region  = cable3_pct_region/100) 

wind_tbl_fmt = 
  
  wind_tbl %>%
  mutate(
   # pct_region         = percent(pct_region),
   # cable2_pct         = percent(cable2_pct),
   # cable2_pct_region  = percent(cable2_pct_region),
   # cable3_pct         = percent(cable3_pct),
   # cable3_pct_region  = percent(cable3_pct_region),
   area_km2           = area_km2   %>% round(digits=1) %>% comma(),
   cable2_km2         = cable2_km2 %>% round(digits=1) %>% comma(),
   cable3_km2         = cable3_km2 %>% round(digits=1) %>% comma()) %>%
  mutate(
    `Cable (km^2)` = sprintf('%s - %s', cable2_km2, cable3_km2),
    `Cable (%)`   = sprintf('%0.2f - %0.2f%%', cable2_pct, cable3_pct)) %>%
  select(Region=region, `Speed m/s`=`speed m/s`, `Cable (km^2)`, `Cable (%)`, `Region (km^2)`=area_km2)
  # rename(
  #   rgn = region,
  #   rgn_km2      = area_km2,
  #   pct_rgn      = pct_region,
  #   cbl2_km2     = cable2_km2,
  #   cbl2_pct     = cable2_pct,
  #   cbl2_pct_rgn = cable2_pct_region,
  #   cbl3_km2     = cable3_km2,
  #   cbl3_pct     = cable3_pct,
  #   cbl3_pct_rgn = cable3_pct_region) %>%
  # select(rgn, `speed m/s`, rgn_km2, cbl2_km2, cbl2_pct, cbl2_pct_rgn, cbl3_km2, cbl3_pct, cbl3_pct_rgn)

if (out_html){
  wind_tbl %>%
    datatable() %>%
    formatCurrency(
      c('area_km2','cable2_km2','cable3_km2'), 
      currency = "", interval = 3, mark = ",", digits=1) %>%
    #formatRound(
    #  c('area_km2','cable2_km2','cable3_km2'),
    #  digits=2) %>%
    formatPercentage(
      c('pct_region','cable2_pct','cable2_pct_region','cable3_pct','cable3_pct_region'),
      digits=1)
} else {
  wind_tbl_fmt %>%
    kable(
      align=c('l', 'c', 'c', 'c', 'r'),
      caption = 'Constraints of cable (minimum - recommended) categories of wind speed (m/s) at 90m hub height.') # , booktabs=T)
}
```

### Wave

units: wave energy flux (kW/m)

```{r map_wave, eval=T}
#wave_lvls = unique(wave_cbls$energy_lbl)

wave = read_sf(wave_geo)

wave %>% select(`kW/m` = energy_num) %>% as('Spatial') %>%
  spplot()
```


```{r tbl_wave}
# TODO: rm /100 from pct_* in *.R
wave_cbls = read_csv(wave_cbls_csv) %>%
  rename(`flux kW/m`=energy_lbl) %>%
  mutate(
   pct_all        = pct_all/100,
   cable2_pct     = cable2_pct/100,
   cable3_pct     = cable3_pct/100,
   cable3_pct_all = cable3_pct_all/100)

wave_cbls %>%
  select(-energy_num) %>%
  datatable() %>%
  formatCurrency(
      c('area_km2','cable2_km2','cable3_km2'), 
      currency = "", interval = 3, mark = ",", digits=1) %>%
  formatPercentage(
    c('pct_all','cable2_pct','cable2_pct_all','cable3_pct','cable3_pct_all'),
    digits=1)
```

- [plotly - stacked bar chart](https://plot.ly/r/bar-charts/#stacked-bar-chart)
- [plotly - horizontal bar chart](https://plot.ly/r/horizontal-bar-charts/#colored-horizontal-bar-chart)
- [plotly - percentages bar chart](https://plot.ly/ggplot2/geom_bar/#precentages)

```{r plt_wave, eval=T}
wave_cbls = read_csv(wave_cbls_csv)
wave_lvls = unique(wave_cbls$energy_lbl)
cable_ord = c('min_2d'='Minimum (2*depth)', 'rec_3d'='+Recommended (3*depth)', 'rem'='Remainder')
wave_cbls = wave_cbls %>%
  mutate(
    min_2d = cable2_km2,
    rec_3d = cable3_km2 - cable2_km2,
    rem    = area_km2 - cable3_km2,
    energy = factor(
      energy_lbl, wave_lvls, wave_lvls, ordered=T)) %>%
  select(
    energy, min_2d, rec_3d, rem) %>%
  gather(type, km2, -energy) %>%
  mutate(
    type = factor(
      type,
      names(cable_ord),
     cable_ord, ordered=T)) %>%
  arrange(energy, type)

wave_pct = read_csv(wave_cbls_csv) %>%
  mutate(
    energy      = factor(energy_lbl, wave_lvls, wave_lvls, ordered=T),
    pct_lbl_lvl = sprintf('%0.1f - %0.1f%%', cable2_pct, cable3_pct),
    pct_lbl_all = sprintf('all: %0.1f - %0.1f%%', cable2_pct_all, cable3_pct_all)) %>%
  select(energy, area_km2, pct_lbl_lvl, pct_lbl_all)
#View(wave_pct)

p = ggplot(wave_cbls, aes(x = energy, y = km2/1000, fill=type)) +
  geom_col() +
  geom_text(data=wave_pct, aes(label=pct_lbl_lvl, x=energy, y=area_km2/1000, fill=NULL), vjust = -.5) +
  geom_text(data=wave_pct, aes(label=pct_lbl_all, x=energy, y=0, fill=NULL), vjust = -.5) +
  labs(x='Wave energy (kW/m)', y='Area (1,000 km^2)', fill='Type') +
  theme(legend.justification=c(1,1), legend.position=c(1,1))
#p

if (out_html){
  ggplotly(p)
} else {
  print(p)
}
```

### Tidal

units: mean power (W/m^2)

TODO: seperate tif into east and west for display in leaflet

```{r map_tide, eval=F}
tide = raster(tide_tif)

plot(tide_tif)
```


```{r tbl_tide}
tide_cbls = read_csv(tide_cbls_csv)

tide_cbls %>%
  select(-energy_num) %>%
  rename(`power W/m2`=energy_lbl) %>%
  mutate(
   pct_all        = pct_all/100,
   cable2_pct     = cable2_pct/100,
   cable3_pct     = cable3_pct/100,
   cable3_pct_all = cable3_pct_all/100) %>%
  datatable() %>%
  formatCurrency(
      c('area_km2','cable2_km2','cable3_km2'), 
      currency = "", interval = 3, mark = ",", digits=1) %>%
  formatPercentage(
    c('pct_all','cable2_pct','cable2_pct_all','cable3_pct','cable3_pct_all'),
    digits=1)
```

## Next Steps

- stacked histogram by cbl2/(cbl3-cbl2)/other; hist(wind$Speed_90)

- simplify as native geojson

Musial et al (2016):

- wind speed (m/s) -- Table A-3 (p. 48): <7, 7-8, 8-9, 9-10, 10-11, total

- depth classes (m) -- Table B-1 (p. 49): <30, 30-60, 60-700, 700-1000, >1000, total

- distance to shore (nm) -- Table B-2 (p. 50): <3, 3-12, 12-50, 50-200, total

- by states



# Conclusions

## Communication with Stakeholders

Products will be online and readily digestable by stakeholders.

# References
