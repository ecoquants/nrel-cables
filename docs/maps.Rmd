---
title: "Interactive Maps of Submarine Cable Analysis for US Marine Renewable Energy Development"
output:
  bookdown::html_document2:
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=F)

# set working directory
if (basename(getwd()) == 'nrel-cables') setwd('docs')

# load packages and variables
source('./packages_vars.R')

#opts_chunk$set(warning=F, message=F)
opts_chunk$set(warning=F, message=F, eval=T, cache=T) # DEBUG
fig_type = 'png' # 'png','pdf','html'
fig_dpi = 300
redo = F

if (interactive() || "rmarkdown.pandoc.to" %in% names(opts_knit$get()) && opts_knit$get("rmarkdown.pandoc.to") == 'html'){
  out_html = T
  #opts_chunk$set(echo=T)
  opts_chunk$set(echo=F)
} else {
  out_html = F
  opts_chunk$set(echo=F)
}

fmt_tbl = function(csv, energy_hdr, caption){

  # read_csv(csv) %>%
  #   mutate(
  #    cable2_pct = cable2_pct/100, 
  #    cable3_pct = cable3_pct/100) %>%
  #   write_csv(csv)
  
  d = read_csv(csv) %>%
    filter(
      territory != 'ALL',
      !is.na(territory))
  
  # correct for odd flipping from using className='dt-right'
  d = d %>%
    mutate(
      energy_lbl = recode(
        energy_lbl, 
        `<=7`='7=>',
        `>30`='30<',
        `>1500`='1500<'))
  
  hdr = htmltools::withTags(table(
    class = 'display',
    thead(
      tr(
        th(rowspan=2, 'Territory'),
        th(rowspan=2, energy_hdr),
        th(rowspan=2, HTML('Area (km<sup>2</sup>)')),
        th(colspan=2, 'Min. Cable (2z)'),
        th(colspan=2, 'Rec. Cable (3z)')),
      tr(
        th(HTML('Area (km<sup>2</sup>)')),
        th('(%)'),
        th(HTML('Area (km<sup>2</sup>)')),
        th('(%)')))))

  d %>%
    mutate(
      territory  = ifelse(duplicated(territory), '', territory),
      energy     = factor(energy_num, unique(energy_num), unique(energy_lbl)),
      area_km2   = accounting(area_km2, digits=0),
      cable2_km2 = accounting(cable2_km2, digits=0),
      cable3_km2 = accounting(cable3_km2, digits=0),
      cable2_pct = percent(cable2_pct, digits=1),
      cable3_pct = percent(cable3_pct, digits=1)) %>%
    select(
      territory, energy, area_km2,
      cable2_km2, cable2_pct, cable3_km2, cable3_pct) %>%
    formattable(
      list(
        energy     = color_bar('lightblue'),
        area_km2   = color_bar('lightgray'),
        cable2_km2 = color_bar('lightpink'),
        cable3_km2 = color_bar('lightgreen'))) %>%
    as.datatable(
      rownames=F, container=hdr, caption=caption,
      options = list(
        dom='t', # off: n_entries/search/paging/ordering
        pageLength = nrow(d), ordering=F,
        columnDefs = list(list(className='dt-right', targets=1:5))))
}

plot_cbls = function(
  csv   = wave_cbls_csv, 
  #title = 'Wave Energy by Area and Power Class per US Territory',
  xlab  = 'Wave energy (kW/m)',
  legend_position      = c(1,0),
  legend_justification = c(1,0)){ 
  
  energy_cbls = read_csv(csv) %>%
    filter(
      !is.na(territory),
      territory != 'ALL') %>%
    mutate(
      energy = factor(energy_lbl, unique(energy_lbl), ordered=T),
      pct_lbl = sprintf('%0.1f - %0.1f%%', cable2_pct*100, cable3_pct*100))
  
  #cable_ord = c('min_2d'='Minimum (2*depth)', 'rec_3d'='+Recommended (3*depth)', 'rem'='Available')
  cable_ord = c('min_2d'='Min.(2z)', 'rec_3d'='+Rec.(3z)', 'rem'='Free')
  
  d_p = energy_cbls %>%
    mutate(
      min_2d = cable2_km2,
      rec_3d = cable3_km2 - cable2_km2,
      rem    = area_km2 - cable3_km2) %>%
    select(
      territory, energy, min_2d, rec_3d, rem) %>%
    gather(type, km2, -energy, -territory) %>%
    mutate(
      type = factor(
        type,
        names(cable_ord),
       cable_ord, ordered=T)) %>%
    arrange(territory, energy, type)
  
  txt_adj = energy_cbls %>% 
    summarize(txt_adj = max(area_km2)/1000*0.025) %>% 
    .$txt_adj
  
  p = ggplot(
      data=d_p,
      aes(x = energy, y = km2/1000, fill=type)) +
    geom_col() +
    geom_text(
      data=energy_cbls, 
      aes(label=pct_lbl, x=energy, y=area_km2/1000, fill=NULL), 
      position = position_nudge(y = txt_adj), size=2) +
    labs(
      #title=title, 
      #subtitle='with Cable Overlay (Minimum - Recommended %)', 
      x=xlab, y='Area (1,000 km^2)', fill='Cable') +
    theme(
      legend.justification = legend_justification, 
      legend.position      = legend_position,
      axis.text.x = element_text(angle = 90, hjust = 1)) + 
    facet_wrap(~territory) # facet_wrap(~territory, scales='free_y') # facet_grid(. ~ territory)
  print(p)
}

fig_exists = function(fig){ 
  fig_ext = sprintf('%s.%s', fig, fig_type)
  file.exists(fig_ext)}

map_energy_sf = function(
  energy_sf,
  ter,
  legend_title){
  # ter = 'Hawaii'; fig = sprintf('figs/mapWind_%s', str_replace_all(ter,' ','-')); energy_sf = wind_sf; legend_title = 'Wind\nspeed\n(m/s)'; redo = T
  
  d = energy_sf %>% 
    filter(territory==ter)
  eez = usa_eez %>%
    filter(territory==ter)
  cables = lns_d1x %>%
    filter(territory==ter)
  cables2 = dx2 %>%
    filter(territory==ter)
  cables3 = dx3 %>%
    filter(territory==ter)
  
  bb = st_bbox(d)

  pal = colorFactor('YlGnBu', d$energy, reverse=T)
  
  m = leaflet(d) %>% 
    addProviderTiles('Esri.OceanBasemap') %>%
    addPolygons(
      group=legend_title,
      color=NA, smoothFactor = 0.5,
      fillOpacity = 0.5,
      fillColor = ~pal(energy)) %>% 
    addPolygons(
      data = cables2, group='Min. Cable (2x)',
      color='red', stroke=F, fillOpacity = 0.3) %>%
    addPolygons(
      data = cables3, group='Rec. Cable (3x)',
      color='red', stroke=F, fillOpacity = 0.3) %>%      
    addPolylines(
      data = cables, group='Cables',
      color='red', opacity = 0.8, weight=1) %>% #,
    fitBounds(bb[['xmin']],bb[['ymin']],bb[['xmax']],bb[['ymax']]) %>%
    addLegend(position='bottomright', pal=pal, values=~energy, title=legend_title) %>%
    addLayersControl(
      baseGroups = c("B&W", "Ocean"),
      overlayGroups = c(legend_title, 'Min. Cable (2x)', 'Rec. Cable (3x)', 'Cables'),
      options = layersControlOptions(collapsed=T))
   m
}

map_tide = function(
  ter,
  legend_title,
  redo,
  fig){
  # ter = 'Alaska'; fig = sprintf('figs/mapTide_%s', str_replace_all(ter,' ','-')); legend_title = 'Tidal\npower\n(W/m2)'; redo = T
  
  fig_ext = sprintf('%s.%s', fig, fig_type)
  if (!file.exists(fig_ext) | redo){
    
    ter_str = str_replace_all(ter, ' ', '-')
    tif = sprintf('../data/tide_ter-%s.tif', ter_str)
    r = raster(tif)

    #d = energy_sf %>% 
    #  filter(territory==ter)
    eez = usa_eez %>%
      filter(territory==ter)
    cables = lns_d1x %>%
      filter(territory==ter)
    cables2 = dx2 %>%
      filter(territory==ter)
    cables3 = dx3 %>%
      filter(territory==ter)
    
    bb = bbox(r)
    bb = c(xmin=bb[1,1], xmax=bb[1,2], ymin=bb[2,1], ymax=bb[2,2])
    # TODO: st_cast(x=st_bbox, to=st_polygon)                 
    bb_ply = st_sf(
      tibble(
        territory = ter,
        geom = st_sfc(st_polygon(list(rbind(
          c(bb['xmin'], bb['ymin']),
          c(bb['xmax'], bb['ymin']),
          c(bb['xmax'], bb['ymax']),
          c(bb['xmin'], bb['ymax']),
          c(bb['xmin'], bb['ymin'])))), crs = 4326)))
    earth = land %>%
      filter(
        st_intersects(land, bb_ply, sparse=F)[,1])

    # https://nrelscience.org/2013/05/30/this-is-how-i-did-it-mapping-in-r-with-ggplot2/
    d = as.data.frame(r, xy=T) %>% as_tibble()
    colnames(d) <- c('lon','lat','value')
    d = d %>% filter(!is.na(value))
    
    p = ggplot() + 
      geom_raster(data=d, aes(x=lon, y=lat, fill=value)) + 
      scale_fill_gradientn(
        legend_title,
        colours=rev(brewer.pal(11,'YlGnBu')),
        limits=c(0,cellStats(r, 'max')),
        na.value = 'transparent') +
      geom_sf(data=earth, fill='gray40', size=0.2, color=NA) +
      geom_sf(data=eez, fill=NA, color='gray40') +
      geom_sf(data=cables3, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables2, fill='red', color=NA, alpha=0.15) +
      geom_sf(data=cables, color='red', size=0.1, alpha=0.9) +
      coord_sf(
        xlim=bb[c('xmin','xmax')], 
        ylim=bb[c('ymin','ymax')]) +
      theme(
        legend.background = element_rect(fill='grey90'),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),  
        legend.key = element_blank())
      
    if (fig_type=='pdf'){
      pdf(fig_ext, width=6.5, height=5)
    }  else {
      png(fig_ext, res=fig_dpi, width=6.5, height=5, units='in')
    }
    print(p)
    dev.off()
    
  }
  #system(sprintf('open %s', fig))
  #knitr::include_graphics(fig_ext, auto_pdf=F, dpi=fig_dpi)
}

# calculate length of cables / comment to speed up
# lns_km = read_sf(lns_geo) %>%
#   mutate(
#     length = st_length(geometry)) %>%
#   summarize(length_km = sum(length)/1000) %>% 
#   .$length_km %>% as.numeric()
# 
# lns_d1x_km = lns_d1x %>%
#   mutate(
#     length = st_length(geometry)) %>%
#   summarize(length_km = sum(length)/1000) %>% 
#   .$length_km %>% as.numeric()
lns_km = 230834.9
lns_d1x_km = 97321.2

# revert to old red-green-blue default color, not new viridis
#   per https://github.com/tidyverse/ggplot2/blob/00ecd3670ef0f1c195bf4c6b5ada3b1895712f1c/NEWS.md#ggplot2-2219000
scale_fill_ordinal = scale_fill_hue

#usa2    = wrld2 %>% filter(ID=='USA')
wrld2   = st_as_sf(map('world2', plot=F, fill=T))
usa_eez = read_sf(usa_rgn_geo)
land    = read_sf(land_usaeez_geo)
lns_d1x = read_sf(lns_d1x_rgn_geo)
dx2     = read_sf(dx2_geo)
dx3     = read_sf(dx3_geo)
usa_dx = read_csv(usa_dx_csv)
```

```{r mapTide, eval=F}
territories = read_csv(tide_cbls_csv) %>% 
  filter(territory !='ALL') %>% 
  .$territory %>% unique()

for (ter in territories){ # ter = 'Hawaii'
  map_tide(
    ter = ter,
    legend_title = 'Tidal\npower\n(W/m2)',
    fig = sprintf('figs/mapTide_%s', str_replace_all(ter,' ','-')),
    redo = redo)
  #system(sprintf('open %s', fig))
}
#knitr::include_graphics(sprintf('figs/mapTide_%s.pdf', str_replace_all(territories,' ','-')), dpi=fig_dpi)
```

## Wind

```{r mapWind_data}
wind_sf = read_sf(wind_geo) %>%
  arrange(energy_num) %>%
  mutate(
    energy = factor(
      energy_num, unique(energy_num), unique(energy_lbl), ordered=T)) %>%
  arrange(region, energy)
```

### East

```{r}
map_energy_sf(wind_sf, 'East', 'Wind\nspeed\n(m/s)')
```

### Gulf of Mexico

```{r}
map_energy_sf(wind_sf, 'Gulf of Mexico', 'Wind\nspeed\n(m/s)')
```

### Hawaii

```{r}
map_energy_sf(wind_sf, 'Hawaii', 'Wind\nspeed\n(m/s)')
```

### West

```{r}
map_energy_sf(wind_sf, 'West', 'Wind\nspeed\n(m/s)')
```

## Wave

```{r mapWave_data}
wave_sf = read_sf(wave_geo) %>%
  filter(!is.na(territory)) %>%
  mutate(
    energy = factor(
      energy_num, unique(energy_num), unique(energy_lbl), ordered=T))
```

### Alaska

```{r}
map_energy_sf(wave_sf, 'Alaska', 'Wave\nenergy\n(kW/m)')
```

### East

```{r}
map_energy_sf(wave_sf, 'East', 'Wave\nenergy\n(kW/m)')
```

### Gulf of Mexico

```{r}
map_energy_sf(wave_sf, 'Gulf of Mexico', 'Wave\nenergy\n(kW/m)')
```

### Hawaii

```{r}
map_energy_sf(wave_sf, 'Hawaii', 'Wave\nenergy\n(kW/m)')
```

### Puerto Rico

```{r}
map_energy_sf(wave_sf, 'Puerto Rico', 'Wave\nenergy\n(kW/m)')
```

### US Virgin Islands

```{r}
map_energy_sf(wave_sf, 'US Virgin Islands', 'Wave\nenergy\n(kW/m)')
```


### West

```{r}
map_energy_sf(wave_sf, 'West', 'Wave\nenergy\n(kW/m)')
```

